<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NH BOX - Stream Movies & Web Series</title>
    
    <!-- PWA Requirements -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d47a1"/>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <!-- HLS.js is kept in case a movie/series uses an m3u8 link -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- START: THEME DEFINITIONS --- */
        :root, body[data-theme="filmzio-dark"] {
            --primary-color: #00aaff;
            --primary-color-hover: #0088cc;
            --bg-color: #10141f;
            --text-color: #fff;
            --secondary-text-color: #aaa;
            --card-bg: #1a2035;
            --section-bg: #10141f;
            --header-bg: linear-gradient(to bottom, rgba(26, 32, 53, 0.9), rgba(26, 32, 53, 0.7));
            --border-color: #2a314b;
            --shadow-color: rgba(0,0,0,0.3);
            --body-bg-image: none;
            --body-font: 'Poppins', sans-serif;
            --gold-color: #FFD700;
            --platinum-color: #E5E4E2;
            --diamond-color: #B9F2FF;
        }
        
        body[data-theme="classic-dark"] {
            --primary-color: #e50914;
            --primary-color-hover: #c40812;
            --bg-color: #000;
            --text-color: #fff;
            --secondary-text-color: #aaa;
            --card-bg: #181818;
            --section-bg: #000;
            --header-bg: linear-gradient(to bottom, rgba(0,0,0,0.9), rgba(0,0,0,0.7));
            --border-color: #333;
            --shadow-color: rgba(0,0,0,0.3);
            --body-bg-image: none;
            --gold-color: #FFD700;
            --platinum-color: #E5E4E2;
            --diamond-color: #B9F2FF;
        }

        body[data-theme="neon-glow"] {
            --primary-color: #ff00c8;
            --primary-color-hover: #00e5ff;
            --bg-color: #0d0221;
            --text-color: #f0f0f0;
            --secondary-text-color: #8c82a2;
            --card-bg: #1d1135;
            --section-bg: #0d0221;
            --header-bg: linear-gradient(to bottom, rgba(13, 2, 33, 0.9), rgba(13, 2, 33, 0.7));
            --border-color: #2a1a4a;
            --shadow-color: rgba(0, 229, 255, 0.2);
            --body-bg-image: none;
            --gold-color: #FFD700;
            --platinum-color: #E5E4E2;
            --diamond-color: #B9F2FF;
        }

        body[data-theme="gradient-luxe"] {
            --primary-color: #ffffff;
            --primary-color-hover: #dddddd;
            --bg-color: #1a1a2e; /* Fallback */
            --text-color: #ffffff;
            --secondary-text-color: #bdc3c7;
            --card-bg: rgba(255, 255, 255, 0.1);
            --section-bg: transparent;
            --header-bg: linear-gradient(to bottom, rgba(0,0,0,0.7), rgba(0,0,0,0.4));
            --border-color: rgba(255, 255, 255, 0.2);
            --shadow-color: rgba(0,0,0,0.3);
            --body-bg-image: linear-gradient(135deg, #480ca8, #0077b6);
            --gold-color: #FFD700;
            --platinum-color: #E5E4E2;
            --diamond-color: #B9F2FF;
        }

        body[data-theme="minimal-light"] {
            --primary-color: #e50914;
            --primary-color-hover: #c40812;
            --bg-color: #f4f4f4;
            --text-color: #000000;
            --secondary-text-color: #555;
            --card-bg: #ffffff;
            --section-bg: #f4f4f4;
            --header-bg: linear-gradient(to bottom, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            --border-color: #e0e0e0;
            --shadow-color: rgba(0,0,0,0.1);
            --body-bg-image: none;
            --gold-color: #D4AF37;
            --platinum-color: #A9A9A9;
            --diamond-color: #20B2AA;
        }
        /* --- END: THEME DEFINITIONS --- */

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--body-font), 'Helvetica Neue', Helvetica, Arial, sans-serif; transition: background-color 0.4s ease, color 0.4s ease, border-color 0.4s ease; }
        
        body { background-color: var(--bg-color); background-image: var(--body-bg-image); background-size: cover; background-attachment: fixed; color: var(--text-color); margin: 0; overflow: hidden; -webkit-font-smoothing: antialiased; }

        #page-container {
            position: relative;
            max-width: 480px;
            margin: 0 auto;
            height: 100vh;
            perspective: 1500px;
        }

        .page {
            background-color: var(--section-bg);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            backface-visibility: hidden;
            transform-style: preserve-3d;
            opacity: 0;
            pointer-events: none;
            transform: rotateY(45deg) scale(0.9);
            transition: transform 0.7s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.7s cubic-bezier(0.4, 0, 0.2, 1);
            padding-bottom: 70px;
        }
        body[data-theme="gradient-luxe"] .page { background-color: transparent; }

        .page.active {
            opacity: 1;
            pointer-events: auto;
            transform: rotateY(0) scale(1);
            z-index: 2;
        }
        .page.exit {
            transform: rotateY(-45deg) scale(0.9);
            opacity: 0;
            z-index: 1;
        }
        
        #install-pwa-btn {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: none;
            padding: 12px 24px;
            background-color: var(--primary-color);
            color: var(--bg-color);
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px var(--shadow-color);
            transition: transform 0.2s ease-out;
        }
        #install-pwa-btn:hover {
            transform: translateX(-50%) scale(1.05);
        }

        .header { background: var(--header-bg); padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); }
        .logo-container { display: flex; align-items: center; gap: 10px; }
        .logo { font-size: 28px; font-weight: bold; color: var(--text-color); font-style: italic; }
        .logo .fa-film { color: var(--primary-color); margin-left: 5px;}
        .header-controls { flex: 1; display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-left: 15px; }
        .search-input { width: 100%; max-width: 200px; flex: 1; padding: 10px 15px; background-color: rgba(255,255,255,0.1); border: 1px solid var(--border-color); border-radius: 20px; color: var(--text-color); font-size: 14px; }
        
        .live-indicator {
            display: none; /* Hidden by default, enabled by JS */
            align-items: center;
            gap: 5px;
            background-color: var(--primary-color);
            color: var(--text-color);
            font-size: 12px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 5px;
            cursor: pointer;
            animation: blink-live 1.5s infinite;
        }
        .live-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            background-color: #fff;
            border-radius: 50%;
        }
        @keyframes blink-live {
            0%, 100% { opacity: 1; box-shadow: 0 0 5px var(--primary-color); }
            50% { opacity: 0.7; box-shadow: 0 0 15px var(--primary-color); }
        }

        #profile-page, #watchlist-page { min-height: 100vh; }
        .list-group-item { background-color: var(--card-bg); padding: 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s; border: 1px solid var(--border-color); color: var(--text-color); display: flex; align-items: center; }
        .list-group-item i { margin-right: 15px; color: var(--primary-color); width: 20px; text-align: center; }

        .profile-info-container { display: flex; flex-direction: column; align-items: center; padding: 20px 0; gap: 25px; }
        .profile-button-group { display: flex; gap: 10px; width: 100%; max-width: 320px; }
        .profile-button-group .btn {
            padding: 10px 15px;
            font-size: 14px;
        }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 1100; display: none; justify-content: center; align-items: center; padding: 15px; }
        .modal-content { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; width: 100%; max-width: 450px; max-height: 90vh; display: flex; flex-direction: column; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-close { position: absolute; top: 10px; right: 10px; background: var(--primary-color); color: var(--bg-color); border: none; width: 30px; height: 30px; border-radius: 50%; font-size: 20px; cursor: pointer; line-height: 30px; text-align: center; }
        #episode-modal-title, #request-modal-title, #privacy-policy-title, #complaint-modal-title, #checkout-modal-title, #coupon-modal-title { padding: 15px; font-size: 20px; border-bottom: 1px solid var(--border-color); color: var(--text-color); }
        #episode-modal-list, #request-modal-form, #privacy-policy-content, #checkout-modal-body, #coupon-modal-body { padding: 15px; overflow-y: auto; }
        #privacy-policy-content p { margin-bottom: 15px; line-height: 1.6; color: var(--secondary-text-color); }
        #privacy-policy-content h3 { color: var(--primary-color); margin-top: 20px; margin-bottom: 10px; font-size: 16px; }
        .episode-season-header { font-size: 16px; font-weight: bold; color: var(--primary-color); margin-top: 15px; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--secondary-text-color); font-size: 14px; }
        .form-group input { width: 100%; padding: 12px; background-color: rgba(255,255,255,0.1); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); font-size: 14px; }
        
        #series-player-modal { align-items: flex-end; }
        .series-player-content { position: relative; background-color: var(--card-bg); width: 100%; max-width: 480px; height: 95vh; max-height: 800px; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; overflow: hidden; transform: translateY(100%); transition: transform 0.4s ease-out; }
        #series-player-modal.active .series-player-content { transform: translateY(0); }
        .series-video-container { width: 100%; aspect-ratio: 16/9; background-color: #000; flex-shrink: 0; }
        .series-video-container iframe { width: 100%; height: 100%; } /* MODIFIED FOR IFRAME */
        .series-episode-list-container { padding: 15px; flex-grow: 1; overflow-y: auto; }
        .series-episode-list-container .episode-item.playing { background-color: var(--primary-color) !important; }
        .series-episode-list-container .episode-item.playing .episode-title, .series-episode-list-container .episode-item.playing .episode-meta { color: var(--bg-color); }
        .series-player-close { z-index: 10; }

        /* Upcoming Modal Styles */
        #upcoming-modal .modal-content { max-width: 320px; padding: 20px; align-items: center; text-align: center; }
        #upcoming-modal-poster { width: 100%; max-width: 250px; height: auto; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); }
        #upcoming-modal-title { font-size: 22px; font-weight: bold; margin-bottom: 8px; }
        #upcoming-modal-release-date { font-size: 14px; color: var(--secondary-text-color); margin-bottom: 20px; }
        #upcoming-modal-countdown, #maintenance-countdown-timer { display: flex; gap: 10px; justify-content: center; }
        .countdown-item { background-color: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; min-width: 60px; }
        .countdown-number { font-size: 28px; font-weight: bold; color: var(--primary-color); }
        .countdown-label { font-size: 12px; color: var(--secondary-text-color); }
        
        /* Floating Complaint Icon */
        #complaint-fab {
            position: fixed;
            bottom: 85px; /* Above nav bar */
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: var(--primary-color);
            color: var(--bg-color);
            border-radius: 50%;
            display: none; /* Hidden until logged in */
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1000;
            animation: fab-pulse 2s infinite;
            transition: transform 0.3s;
        }
        #complaint-fab:hover {
            transform: scale(1.1);
            animation-play-state: paused;
        }
        @keyframes fab-pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 170, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 170, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 170, 255, 0); }
        }

        .btn { background-color: var(--primary-color); color: var(--bg-color); border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; flex: 1; display: flex; justify-content: center; align-items: center; gap: 8px; transition: all 0.3s; box-shadow: 0 4px 8px rgba(0, 170, 255, 0.3); } .btn:hover { background-color: var(--primary-color-hover); transform: translateY(-2px); } .btn-secondary { background-color: rgba(255,255,255,0.2); backdrop-filter: blur(10px); box-shadow: 0 4px 8px var(--shadow-color); color: var(--text-color); } .page-header { padding: 20px 15px; font-size: 24px; font-weight: bold; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; color: var(--text-color); } .loading-screen, #login-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; } .loading-logo, .login-box .logo { font-size: 48px; font-weight: bold; color: var(--text-color); margin-bottom: 20px; animation: pulse 1.5s infinite; font-style: italic;} .loading-logo .fa-film, .login-box .logo .fa-film { color: var(--primary-color);} #login-name { width: 100%; padding: 15px; font-size: 16px; margin-bottom: 20px; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 5px; color: var(--text-color); } #login-btn { width: 100%; padding: 15px; font-size: 16px; background-color: var(--primary-color); color: var(--bg-color); border: none; border-radius: 5px; font-weight: bold; cursor: pointer; } @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } } .category-section { margin-bottom: 35px; } .category-title { font-size: 20px; font-weight: bold; color: var(--text-color); position: relative; padding-left: 15px; } .category-title::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 5px; height: 20px; background-color: var(--primary-color); border-radius: 3px; } .content-slider { display: flex; overflow-x: auto; padding: 20px 15px; scrollbar-width: none; gap: 12px; } .content-slider::-webkit-scrollbar { display: none; } .content-card { flex: 0 0 calc(33.33% - 8px); position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 8px var(--shadow-color); transition: all 0.3s; cursor: pointer; background: var(--card-bg); } .content-card:hover { transform: scale(1.05); } .content-card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; } 
        .detail-backdrop { width: 100%; height: 250px; position: relative; } .detail-backdrop img { width: 100%; height: 100%; object-fit: cover; } .detail-backdrop::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 120px; background: linear-gradient(to top, var(--bg-color), transparent); } body[data-theme="gradient-luxe"] .detail-backdrop::after { background: linear-gradient(to top, var(--card-bg), transparent); } .detail-content { padding: 15px; display: flex; margin-top: -80px; position: relative; z-index: 10; } .detail-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; color: var(--text-color); } .detail-meta span { color: var(--secondary-text-color); } .detail-storyline { color: var(--text-color); } .episode-item, .comment-item { background-color: var(--card-bg); border-radius: 10px; padding: 12px; margin-bottom: 12px; border: 1px solid var(--border-color); } .episode-item:hover { background-color: var(--primary-color-hover); } .loading-text { color: var(--secondary-text-color); } #login-page { display: none; } .login-box { width: 100%; max-width: 320px; text-align: center; } .slider-container { position: relative; width: 100%; height: 220px; overflow: hidden; margin-bottom: 25px; border-radius: 15px; margin: 15px;} .slider { display: flex; transition: transform 0.5s ease; height: 100%; } .slide { min-width: 100%; height: 100%; position: relative; } .slide img { width: 100%; height: 100%; object-fit: cover; } .slide-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); padding: 20px; } .slide-title { font-size: 22px; font-weight: bold; margin-bottom: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); } .slide-meta { font-size: 14px; color: #ddd; display: flex; align-items: center; gap: 10px; } .slide-rating { display: flex; align-items: center; gap: 5px; color: #ffd700; } .slider-indicators { position: absolute; bottom: 15px; right: 15px; display: flex; gap: 8px; } .indicator { width: 8px; height: 8px; border-radius: 50%; background-color: rgba(255,255,255,0.5); cursor: pointer; transition: all 0.3s; } .indicator.active { background-color: var(--primary-color); transform: scale(1.2); } .category-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 15px; } .see-all { color: var(--primary-color); font-size: 14px; text-decoration: none; font-weight: bold; } .see-all i { margin-left: 4px; font-size: 12px; } .content-title { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); padding: 30px 10px 10px; font-size: 13px; font-weight: bold; text-align: center; } .detail-poster { width: 120px; height: 180px; border-radius: 10px; overflow: hidden; border: 3px solid var(--border-color); margin-right: 15px; } .detail-poster img { width: 100%; height: 100%; object-fit: cover; } .detail-info { flex: 1; } .detail-meta { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 15px; font-size: 14px; } .detail-meta span i { color: var(--primary-color); margin-right: 5px; } .detail-actions { display: flex; gap: 12px; margin: 20px 0; } .detail-storyline { margin-bottom: 25px; line-height: 1.6; font-size: 15px; } .detail-cast, .similar-section, .comments-section { margin-bottom: 25px; } .detail-cast h3, .similar-section h3, .comments-section h3 { font-size: 18px; margin-bottom: 15px; color: var(--text-color); position: relative; padding-left: 15px; } .detail-cast h3::before, .similar-section h3::before, .comments-section h3::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 5px; height: 18px; background-color: var(--primary-color); border-radius: 3px; } .cast-list { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 10px; } .cast-item { text-align: center; min-width: 80px; } .cast-item img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-bottom: 8px; border: 3px solid var(--border-color); cursor: pointer; } .cast-item:hover img { border-color: var(--primary-color); } .cast-item p { font-size: 13px; color: var(--secondary-text-color); } .episode-thumbnail { width: 100px; height: 56px; border-radius: 6px; margin-right: 12px; flex-shrink: 0;} .episode-thumbnail img { width: 100%; height: 100%; object-fit: cover; } .episode-info { flex: 1; } .episode-title { font-size: 15px; font-weight: bold; margin-bottom: 5px; color: var(--text-color); } .episode-meta { font-size: 13px; color: var(--secondary-text-color); } .episode-play { background-color: var(--primary-color); color: var(--bg-color); border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 16px; margin-left: 10px; } .comment-form { display: flex; margin-bottom: 20px; background-color: var(--card-bg); border-radius: 10px; border: 1px solid var(--border-color); } .comment-input { flex: 1; padding: 12px 15px; background-color: transparent; border: none; color: var(--text-color); } .comment-btn { background-color: var(--primary-color); color: var(--bg-color); border: none; padding: 0 20px; cursor: pointer; } .comments-list { max-height: 250px; overflow-y: auto; } .comment-header { display: flex; justify-content: space-between; margin-bottom: 8px; } .comment-user { font-weight: bold; color: var(--primary-color); } .comment-time { font-size: 12px; color: #666; } .comment-text { font-size: 14px; line-height: 1.5; color: var(--text-color); } .content-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 0 15px; } .placeholder-text { padding: 40px 15px; text-align: center; color: var(--secondary-text-color); }
        
        .content-language-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            background-color: rgba(0, 170, 255, 0.85);
            color: #fff;
            padding: 3px 7px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            z-index: 2;
            text-transform: capitalize;
            backdrop-filter: blur(2px);
        }

        .comment-reply {
            margin-top: 12px;
            padding: 10px;
            background-color: rgba(0, 170, 255, 0.1);
            border-left: 3px solid var(--primary-color);
            border-radius: 0 5px 5px 0;
        }
        .comment-reply-header {
            font-size: 13px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .comment-reply-text {
            font-size: 14px;
            color: var(--secondary-text-color);
            line-height: 1.5;
        }

        .list-group { list-style: none; text-align: left; padding: 0 15px;} 
        .video-player, .cast-full-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 1200; display: none; } 
        .video-player iframe { width: 100%; height: 100%; } /* MODIFIED FOR IFRAME */
        .video-controls { position: fixed; top: 15px; right: 15px; z-index: 1201; display:flex; gap: 10px;} 
        .video-close, .cast-full-close, .video-download { background: rgba(0,0,0,0.7); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; text-decoration: none; display:flex; align-items:center; justify-content:center;} 
        .video-download { display: none; }
        .back-btn { position: fixed; background: rgba(0,0,0,0.7); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; top: 15px; left: 15px; display: none; z-index: 1001; }
        .cast-full-view { z-index: 1200; background-color: rgba(0,0,0,0.95); justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(10px); } .cast-full-view img { max-width: 90%; max-height: 70%; border-radius: 10px; } .cast-full-name { margin-top: 20px; font-size: 24px; font-weight: bold; }
        
        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px; 
            background-color: var(--card-bg);
            backdrop-filter: blur(10px);
            display: flex; 
            justify-content: space-around; 
            padding: 10px 0; 
            z-index: 500; 
            border-top: 1px solid var(--border-color);
        }
        body[data-theme="minimal-light"] .bottom-nav { background-color: rgba(255,255,255,0.85); }

        .nav-item { 
            color: var(--secondary-text-color); 
            text-align: center; 
            flex: 1; 
            font-size: 12px;
            cursor: pointer;
            transition: color 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .nav-item.active, .nav-item:hover { 
            color: var(--primary-color); 
        }
        .nav-item i { 
            font-size: 20px; 
            margin-bottom: 4px;
            transition: all 0.3s ease;
        }
        .nav-item.active i, .nav-item:hover i {
            transform: translateY(-2px);
        }

        #ad-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,1);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .ad-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 480px; /* Match page container */
            display: flex;
            flex-direction: column;
            background-color: #000;
        }
        .ad-header {
            background-color: #111;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #fff;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
        }
        #ad-countdown-text {
            font-size: 14px;
            color: var(--secondary-text-color);
        }
        #ad-skip-btn {
            background-color: var(--primary-color);
            color: var(--bg-color);
            border: none;
            padding: 6px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        #ad-iframe {
            width: 100%;
            height: 100%;
            flex-grow: 1;
            border: none;
        }

        .trending-rank { position: absolute; bottom: 4px; left: 4px; font-size: 70px; font-weight: 900; color: var(--text-color); z-index: 3; line-height: 0.8; text-shadow: 0 2px 8px rgba(0,0,0,0.9); -webkit-text-stroke: 1px rgba(0,0,0,0.5); pointer-events: none; }

        /* Poll Styles */
        #poll-popup { position: fixed; bottom: 75px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); z-index: 1050; overflow: hidden; animation: slideUp 0.5s ease-out; }
        @keyframes slideUp { from { transform: translate(-50%, 100px); opacity: 0; } to { transform: translateX(-50%); opacity: 1; } }
        #poll-header { background-color: rgba(0,0,0,0.3); padding: 8px 15px; font-weight: bold; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border-color); }
        #poll-close-btn { margin-left: auto; background: none; border: none; color: var(--secondary-text-color); font-size: 24px; cursor: pointer; padding: 0 5px; line-height: 1; }
        #poll-content { padding: 15px; } #poll-question { font-size: 16px; margin-bottom: 15px; font-weight: bold; }
        #poll-options-container .poll-option { display: block; padding: 10px; background-color: rgba(255,255,255,0.1); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        #poll-options-container .poll-option:hover { background-color: rgba(255,255,255,0.2); }
        #poll-options-container .poll-option.selected { background-color: var(--primary-color); border-color: var(--primary-color-hover); color: var(--bg-color); font-weight: bold; }
        #poll-vote-btn { width: 100%; margin-top: 10px; }

        /* Request Marquee Styles */
        .request-marquee-container { background: var(--primary-color); color: #fff; padding: 5px 0; width: 100%; overflow: hidden; white-space: nowrap; font-size: 13px; }
        .request-marquee-text { display: inline-block; padding-left: 100%; animation: marquee 30s linear infinite; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        /* Disclaimer Styles */
        #disclaimer-overlay { z-index: 2001; background-color: rgba(0,0,0,0.9); backdrop-filter: blur(5px); display: none; }
        #disclaimer-content { max-width: 380px; text-align: center; padding: 25px; }
        #disclaimer-content h2 { color: var(--primary-color); margin-bottom: 15px; }
        #disclaimer-content p { font-size: 14px; line-height: 1.6; color: var(--secondary-text-color); margin-bottom: 25px; }
        #enter-btn { width: 100%; }

        /* --- Live TV Styles --- */
        .livetv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; padding: 0 15px; }
        .livetv-card { background-color: var(--card-bg); border-radius: 8px; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid var(--border-color); }
        .livetv-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px var(--shadow-color); border-color: var(--primary-color); }
        .livetv-card img { width: 80%; max-width: 80px; height: auto; margin-bottom: 10px; object-fit: contain; }
        .livetv-card-name { font-size: 12px; color: var(--text-color); text-align: center; font-weight: bold; }

        /* --- Subscription Page Styles --- */
        .subscription-page-container { padding: 0 15px; display: flex; flex-direction: column; gap: 20px; }
        .plan-card { background-color: var(--card-bg); border-radius: 12px; padding: 25px; border: 1px solid var(--border-color); text-align: center; transition: all 0.3s ease; }
        .plan-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .plan-card.GOLD { border-top: 5px solid var(--gold-color); }
        .plan-card.PLATINUM { border-top: 5px solid var(--platinum-color); }
        .plan-card.DIAMOND { border-top: 5px solid var(--diamond-color); }
        .plan-name { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .plan-name.GOLD { color: var(--gold-color); }
        .plan-name.PLATINUM { color: var(--platinum-color); }
        .plan-name.DIAMOND { color: var(--diamond-color); }
        .plan-price { font-size: 36px; font-weight: bold; margin-bottom: 5px; color: var(--text-color); }
        .plan-price span { font-size: 16px; color: var(--secondary-text-color); }
        .plan-validity { color: var(--secondary-text-color); margin-bottom: 25px; }
        .plan-features { list-style: none; padding: 0; margin-bottom: 25px; }
        .plan-features li { margin-bottom: 10px; font-size: 15px; }
        .plan-features li i { color: var(--primary-color); margin-right: 10px; }
        #checkout-qr-code { max-width: 250px; width: 100%; border-radius: 8px; margin: 15px auto; display: block; }

        /* --- Server Maintenance Popup Styles --- */
        #server-maintenance-overlay {
            z-index: 99999; /* Highest z-index */
            background-color: rgba(0,0,0,0.95);
        }
        #server-maintenance-overlay .modal-content {
            max-width: 350px;
            text-align: center;
            padding: 30px;
        }
        #server-maintenance-overlay .modal-content i {
            font-size: 50px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        #maintenance-message {
            color: var(--secondary-text-color);
            line-height: 1.6;
            margin-top: 10px;
            margin-bottom: 25px;
        }
        
        /* --- App Lock Styles --- */
        #app-lock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            z-index: 99999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .app-lock-container {
            width: 100%;
            max-width: 300px;
            text-align: center;
        }
        #app-lock-title {
            font-size: 22px;
            margin-bottom: 20px;
            color: var(--text-color);
        }
        .pin-display {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            height: 30px;
        }
        .pin-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--border-color);
            transition: background-color 0.2s;
        }
        .pin-dot.filled {
            background-color: var(--primary-color);
        }
        .pin-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        .keypad-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-size: 28px;
            font-weight: bold;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .keypad-btn:hover {
            background-color: var(--border-color);
        }
        .app-lock-container.shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* --- THEME SELECTOR STYLES --- */
        #theme-modal-title {
            padding: 15px;
            font-size: 20px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }
        #theme-selector-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }
        .theme-preview-card {
            cursor: pointer;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 10px;
            transition: all 0.3s ease;
        }
        .theme-preview-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
        }
        .theme-preview-card.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 15px var(--primary-color);
        }
        .theme-name {
            text-align: center;
            font-weight: bold;
            margin-top: 10px;
            font-size: 14px;
            color: var(--text-color);
        }
        .theme-preview-mockup {
            height: 100px;
            border-radius: 6px;
            padding: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .theme-preview-mockup > div {
            border-radius: 3px;
        }
        .mockup-header {
            height: 12px;
            margin-bottom: 8px;
            opacity: 0.8;
        }
        .mockup-body {
            flex-grow: 1;
            display: flex;
            gap: 6px;
        }
        .mockup-card {
            width: 33.33%;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* Filmzio Dark Preview */
        .theme-preview-card[data-theme="filmzio-dark"] .theme-preview-mockup { background-color: #10141f; }
        .theme-preview-card[data-theme="filmzio-dark"] .mockup-header { background-color: #00aaff; }
        .theme-preview-card[data-theme="filmzio-dark"] .mockup-card { background-color: #1a2035; }

        /* Classic Dark Preview */
        .theme-preview-card[data-theme="classic-dark"] .theme-preview-mockup { background-color: #000; }
        .theme-preview-card[data-theme="classic-dark"] .mockup-header { background-color: #e50914; }
        .theme-preview-card[data-theme="classic-dark"] .mockup-card { background-color: #181818; }
        
        /* Neon Glow Preview */
        .theme-preview-card[data-theme="neon-glow"] .theme-preview-mockup { background-color: #0d0221; }
        .theme-preview-card[data-theme="neon-glow"] .mockup-header { background-color: #ff00c8; }
        .theme-preview-card[data-theme="neon-glow"] .mockup-card { background-color: #1d1135; }
        .theme-preview-card[data-theme="neon-glow"] .mockup-card:nth-child(2) { background-color: #00e5ff; opacity: 0.6; }

        /* Gradient Luxe Preview */
        .theme-preview-card[data-theme="gradient-luxe"] .theme-preview-mockup { background-image: linear-gradient(135deg, #480ca8, #0077b6); }
        .theme-preview-card[data-theme="gradient-luxe"] .mockup-header { background-color: #fff; }
        .theme-preview-card[data-theme="gradient-luxe"] .mockup-card { background-color: rgba(255, 255, 255, 0.2); }

        /* Minimal Light Preview */
        .theme-preview-card[data-theme="minimal-light"] .theme-preview-mockup { background-color: #f4f4f4; }
        .theme-preview-card[data-theme="minimal-light"] .mockup-header { background-color: #e50914; }
        .theme-preview-card[data-theme="minimal-light"] .mockup-card { background-color: #fff; border: 1px solid #e0e0e0; }
        
        /* --- 3D ID Card Styles --- */
        .id-card-wrapper {
            width: 100%;
            height: 220px;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 2000px;
        }

        .id-card {
            width: 320px;
            height: 190px;
            background: linear-gradient(135deg, #222, #111);
            border-radius: 15px;
            position: relative;
            transform-style: preserve-3d;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5), 0 0 0 2px var(--border-color);
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1), box-shadow 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            animation: float-rotate 12s infinite ease-in-out;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: var(--text-color);
        }

        .id-card-wrapper:hover .id-card {
            box-shadow: 0 30px 60px rgba(0,0,0,0.6), 0 0 0 2px var(--primary-color);
            animation-play-state: paused;
            transform: rotateY(0) rotateX(0) translateY(-5px) scale(1.05);
        }
        
        @keyframes float-rotate {
            0% { transform: rotateY(-5deg) rotateX(10deg); }
            50% { transform: rotateY(5deg) rotateX(-10deg) translateY(-10px); }
            100% { transform: rotateY(-5deg) rotateX(10deg); }
        }

        .id-card-hologram {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(110deg, transparent 30%, rgba(255, 255, 255, 0.2) 50%, transparent 70%);
            background-size: 300% 100%;
            z-index: 2;
            opacity: 0.5;
            animation: shine 8s infinite linear;
            pointer-events: none;
        }

        @keyframes shine {
            0% { background-position: 150% 0; }
            100% { background-position: -150% 0; }
        }

        .id-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .id-card-header .logo { font-size: 22px; }
        .id-card-header span { font-size: 10px; font-weight: bold; color: var(--secondary-text-color); letter-spacing: 1px; }

        .id-card-content {
            display: flex;
            gap: 15px;
            flex-grow: 1;
        }

        .id-card-photo-wrapper {
            width: 80px;
            height: 100px;
            border: 2px solid var(--border-color);
            background: var(--card-bg);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            position: relative; /* For positioning the edit icon */
        }

        .id-card-photo-edit {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0,0,0,0.5);
            color: #fff;
            width: 20px;
            height: 20px;
            font-size: 10px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .id-card-photo-edit:hover { background: var(--primary-color); }

        .id-card-photo { font-size: 50px; }
        .id-card-photo .fa-mars, .id-card-photo .fa-venus { font-size: 60px; }

        .id-card-details {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding-bottom: 5px;
            flex-grow: 1;
        }

        .id-card-name { font-size: 18px; font-weight: bold; line-height: 1.2; word-break: break-word; }
        .id-card-user-id, .id-card-member-since { font-size: 10px; color: var(--secondary-text-color); letter-spacing: 0.5px; text-transform: uppercase; }

        .id-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 5px;
            flex-shrink: 0;
        }

        .id-card-subscription {
            font-size: 12px;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 5px;
            background-color: rgba(255,255,255,0.1);
        }
        .id-card-subscription.GOLD { color: var(--gold-color); border: 1px solid var(--gold-color); }
        .id-card-subscription.PLATINUM { color: var(--platinum-color); border: 1px solid var(--platinum-color); }
        .id-card-subscription.DIAMOND { color: var(--diamond-color); border: 1px solid var(--diamond-color); }
        
        .id-card-chip {
            width: 40px;
            height: 30px;
            background: linear-gradient(135deg, #d4af37, #a9a9a9);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }
        .id-card-chip::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -10px;
            right: -10px;
            height: 1px;
            background: rgba(0,0,0,0.4);
        }
        .id-card-chip::after {
            content: '';
            position: absolute;
            left: 50%;
            top: -10px;
            bottom: -10px;
            width: 1px;
            background: rgba(0,0,0,0.4);
        }
        
        /* NEW: Validity Timer Styles */
        .id-card-validity { margin-top: 8px; }
        .validity-label { font-size: 8px; color: var(--secondary-text-color); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 2px; }
        .validity-timer { font-family: 'Courier New', Courier, monospace; font-size: 18px; font-weight: bold; color: var(--text-color); letter-spacing: 1px; }
        .validity-timer.blinking { animation: blink-animation 1.5s infinite; }
        @keyframes blink-animation {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* --- Icon Selector Modal Styles --- */
        #icon-selector-modal .modal-content { max-width: 340px; }
        #icon-selector-title { padding: 15px; font-size: 20px; border-bottom: 1px solid var(--border-color); color: var(--text-color); }
        #icon-choices { display: flex; justify-content: space-around; padding: 25px; gap: 20px; }
        .icon-choice-btn {
            background-color: var(--card-bg);
            border: 2px solid var(--border-color);
            color: var(--text-color);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .icon-choice-btn:hover { border-color: var(--primary-color); transform: translateY(-5px); }
        .icon-choice-btn i { font-size: 30px; margin-bottom: 5px; }
        .icon-choice-btn span { font-size: 12px; }
    </style>
</head>
<body data-theme="filmzio-dark">
    <div class="loading-screen" id="loading-screen"><div class="loading-logo" id="loading-logo">FILMZIO<i class="fas fa-film"></i></div><div class="loading-text">Loading...</div></div>
    <div id="login-page"><div class="login-box"><div class="logo" id="login-logo">FILMZIO<i class="fas fa-film"></i></div><input type="text" id="login-name" placeholder="Enter your name"><button id="login-btn" onclick="handleLogin()">Continue</button></div></div>
    
    <div class="modal-overlay" id="disclaimer-overlay">
        <div class="modal-content" id="disclaimer-content">
            <h2>Disclaimer</h2>
            <p>
                <span style="color: #e50914; font-weight: bold;">Note:</span> We Do not host any files on our server. All files shared here are collected from the internet from various Encoders and hosted on third-party sites. We do not accept responsibility for content hosted on third-party websites. We just index those links which are already available on the internet.
            </p>
            <button class="btn" id="enter-btn">Enter Home Page</button>
        </div>
    </div>

    <!-- SERVER MAINTENANCE POPUP -->
    <div class="modal-overlay" id="server-maintenance-overlay">
        <div class="modal-content">
            <i class="fas fa-tools"></i>
            <h2 id="maintenance-title">Under Maintenance</h2>
            <p id="maintenance-message">The app is currently down for maintenance. We'll be back shortly. Thank you for your patience!</p>
            <div id="maintenance-countdown-timer" style="display: none;">
                 <div class="countdown-item"><div id="m-countdown-days" class="countdown-number">00</div><div class="countdown-label">Days</div></div>
                 <div class="countdown-item"><div id="m-countdown-hours" class="countdown-number">00</div><div class="countdown-label">Hours</div></div>
                 <div class="countdown-item"><div id="m-countdown-mins" class="countdown-number">00</div><div class="countdown-label">Mins</div></div>
                 <div class="countdown-item"><div id="m-countdown-secs" class="countdown-number">00</div><div class="countdown-label">Secs</div></div>
            </div>
        </div>
    </div>

    <!-- APP LOCK SCREEN -->
    <div id="app-lock-overlay">
        <div class="app-lock-container" id="app-lock-container">
            <h2 id="app-lock-title">Enter Your PIN</h2>
            <div class="pin-display">
                <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
            </div>
            <div class="pin-keypad">
                <button class="keypad-btn" onclick="handlePinInput(1)">1</button>
                <button class="keypad-btn" onclick="handlePinInput(2)">2</button>
                <button class="keypad-btn" onclick="handlePinInput(3)">3</button>
                <button class="keypad-btn" onclick="handlePinInput(4)">4</button>
                <button class="keypad-btn" onclick="handlePinInput(5)">5</button>
                <button class="keypad-btn" onclick="handlePinInput(6)">6</button>
                <button class="keypad-btn" onclick="handlePinInput(7)">7</button>
                <button class="keypad-btn" onclick="handlePinInput(8)">8</button>
                <button class="keypad-btn" onclick="handlePinInput(9)">9</button>
                <button class="keypad-btn" style="visibility: hidden;"></button>
                <button class="keypad-btn" onclick="handlePinInput(0)">0</button>
                <button class="keypad-btn" onclick="handlePinBackspace()"><i class="fas fa-backspace"></i></button>
            </div>
        </div>
    </div>

    <button class="back-btn" id="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
    
    <main id="page-container">
        <div id="home-page" class="page">
            <div class="header">
                <div class="logo-container">
                    <div class="logo" id="header-logo">FILMZIO<i class="fas fa-film"></i></div>
                    <div class="live-indicator" id="live-indicator" onclick="showLiveRequestModal()">LIVE</div>
                </div>
                <div class="header-controls">
                    <input type="text" class="search-input" id="search-input" placeholder="Search...">
                </div>
            </div>

            <div class="slider-container"><div class="slider" id="slider"></div><div class="slider-indicators" id="slider-indicators"></div></div>
            
            <div class="category-section">
                <div class="category-header"><h2 class="category-title">Trending Now</h2></div>
                <div class="content-slider" id="trending-slider"></div>
            </div>

            <div id="categories-container">
                <div class="category-section">
                    <div class="category-header">
                        <h2 class="category-title">Hollywood</h2>
                        <a href="#" class="see-all" onclick="showCategoryPage('Hollywood')">See All <i class="fas fa-chevron-right"></i></a>
                    </div>
                    <div class="content-slider" id="hollywood-slider"></div>
                </div>
                <div class="category-section">
                     <div class="category-header">
                        <h2 class="category-title">Bollywood</h2>
                        <a href="#" class="see-all" onclick="showCategoryPage('Bollywood')">See All <i class="fas fa-chevron-right"></i></a>
                    </div>
                    <div class="content-slider" id="bollywood-slider"></div>
                </div>
                <div class="category-section">
                     <div class="category-header">
                        <h2 class="category-title">South Indian</h2>
                        <a href="#" class="see-all" onclick="showCategoryPage('South Indian')">See All <i class="fas fa-chevron-right"></i></a>
                    </div>
                    <div class="content-slider" id="south-slider"></div>
                </div>
                <div class="category-section">
                    <div class="category-header">
                       <h2 class="category-title">Tollywood (Bengali)</h2>
                       <a href="#" class="see-all" onclick="showCategoryPage('Tollywood (Bengali)')">See All <i class="fas fa-chevron-right"></i></a>
                   </div>
                   <div class="content-slider" id="tollywood-slider"></div>
               </div>
               <div class="category-section">
                    <div class="category-header">
                       <h2 class="category-title">Punjabi Movie</h2>
                       <a href="#" class="see-all" onclick="showCategoryPage('Punjabi Movie')">See All <i class="fas fa-chevron-right"></i></a>
                   </div>
                   <div class="content-slider" id="punjabi-slider"></div>
               </div>
               <div class="category-section">
                    <div class="category-header">
                       <h2 class="category-title">Korean Movie</h2>
                       <a href="#" class="see-all" onclick="showCategoryPage('Korean Movie')">See All <i class="fas fa-chevron-right"></i></a>
                   </div>
                   <div class="content-slider" id="korean-slider"></div>
               </div>
               <div class="category-section">
                    <div class="category-header">
                       <h2 class="category-title">Chinese Movie</h2>
                       <a href="#" class="see-all" onclick="showCategoryPage('Chinese Movie')">See All <i class="fas fa-chevron-right"></i></a>
                   </div>
                   <div class="content-slider" id="chinese-slider"></div>
               </div>
               <div class="category-section">
                    <div class="category-header">
                       <h2 class="category-title">Malayalam Movie</h2>
                       <a href="#" class="see-all" onclick="showCategoryPage('Malayalam Movie')">See All <i class="fas fa-chevron-right"></i></a>
                   </div>
                   <div class="content-slider" id="malayalam-slider"></div>
               </div>
               <div class="category-section">
                    <div class="category-header">
                       <h2 class="category-title">Marathi Movie</h2>
                       <a href="#" class="see-all" onclick="showCategoryPage('Marathi Movie')">See All <i class="fas fa-chevron-right"></i></a>
                   </div>
                   <div class="content-slider" id="marathi-slider"></div>
               </div>
               <div class="category-section">
                    <div class="category-header">
                       <h2 class="category-title">18+ Movies</h2>
                       <a href="#" class="see-all" onclick="showCategoryPage('18+ Movie')">See All <i class="fas fa-chevron-right"></i></a>
                   </div>
                   <div class="content-slider" id="adult-slider"></div>
               </div>
            </div>
        </div>
        
        <div id="detail-page" class="page detail-page"></div>
        <div id="category-page" class="page"></div>
        <div id="movies-page" class="page"></div>
        <div id="series-page" class="page"></div>
        <div id="watchlist-page" class="page"><div class="page-header">My Watch List</div><div class="content-grid" id="watchlist-grid"></div><div id="watchlist-placeholder" class="placeholder-text" style="display: none;">Your watch list is empty.</div></div>
        
        <div id="livetv-page" class="page">
            <div class="page-header">Live TV</div>
            <div class="livetv-grid" id="livetv-grid"></div>
            <div id="livetv-placeholder" class="placeholder-text" style="display: none;">No live channels available right now.</div>
        </div>

        <div id="history-page" class="page"></div>
        <div id="upcoming-page" class="page"><div class="page-header">Upcoming</div><div class="content-grid" id="upcoming-grid"></div><div id="upcoming-placeholder" class="placeholder-text" style="display: none;">No upcoming titles announced yet.</div></div>
        
        <div id="subscription-page" class="page">
            <div class="page-header">Subscription Plans</div>
            <div id="subscription-plans-container" class="subscription-page-container">
            </div>
        </div>

        <div id="profile-page" class="page">
            <div class="page-header">Profile</div>
            <div class="profile-info-container">
                <!-- START: NEW 3D ID CARD -->
                <div class="id-card-wrapper">
                    <div class="id-card">
                        <div class="id-card-hologram"></div>
                        <div class="id-card-header">
                            <div class="logo" id="id-card-logo">FILMZIO <i class="fas fa-film"></i></div>
                            <span>OFFICIAL MEMBER</span>
                        </div>
                        <div class="id-card-content">
                            <div class="id-card-photo-wrapper">
                                <div class="id-card-photo" id="id-card-photo"></div>
                                <span class="id-card-photo-edit" onclick="openIconSelectorModal()"><i class="fas fa-pen"></i></span>
                            </div>
                            <div class="id-card-details">
                                <div>
                                    <div class="id-card-name" id="id-card-name">User Name</div>
                                    <div class="id-card-user-id" id="id-card-user-id">ID: NHB-XXXXXX-XXXX</div>
                                    <div class="id-card-member-since" id="id-card-member-since">MEMBER SINCE: Month Year</div>
                                </div>
                                <div class="id-card-validity">
                                    <div class="validity-label">VALID THRU</div>
                                    <div class="validity-timer" id="id-card-timer">
                                        <span id="validity-days">00</span>:<span id="validity-hours">00</span>:<span id="validity-mins">00</span>:<span id="validity-secs">00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="id-card-footer">
                            <div class="id-card-subscription" id="id-card-subscription">Free Member</div>
                            <div class="id-card-chip"></div>
                        </div>
                    </div>
                </div>
                <!-- END: NEW 3D ID CARD -->
                
                <!-- PROFILE BUTTONS (SMALLER) -->
                <div class="profile-button-group">
                    <button class="btn btn-secondary" onclick="openCouponModal()"><i class="fas fa-ticket-alt"></i> Redeem</button>
                    <button class="btn" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Log Out</button>
                </div>
            </div>
            <div class="list-group">
                <div class="list-group-item" onclick="showSubscriptionPage()"><i class="fas fa-crown"></i> Subscription</div>
                <a id="customer-support-link-item" href="#" target="_blank" class="list-group-item" style="text-decoration: none; display: none;">
                    <i class="fab fa-whatsapp"></i> Customer Support (24/7)
                </a>
                <div class="list-group-item" onclick="handleEditProfile()"><i class="fas fa-user-edit"></i> Edit Profile</div>
                <div class="list-group-item" onclick="openThemeModal()"><i class="fas fa-palette"></i> Themes</div>
                <div class="list-group-item" onclick="showWatchHistory()"><i class="fas fa-history"></i> Watch History</div>
                 <div class="list-group-item" onclick="navigateTo('watchlist-page')"><i class="fas fa-bookmark"></i> Watch List</div>
                <div class="list-group-item" onclick="openRequestModal()"><i class="fas fa-film"></i> Request a Movie</div>
                <div class="list-group-item" onclick="openAppLockModal()"><i class="fas fa-lock"></i> <span id="app-lock-profile-text">Set App Lock</span></div>
                <div class="list-group-item" onclick="shareApplication()"><i class="fas fa-share-alt"></i> Share Application</div>
                <div class="list-group-item" onclick="openPrivacyPolicyModal()"><i class="fas fa-shield-alt"></i> Privacy Policy</div>
                <a href="https://t.me/htmlmovievg" target="_blank" class="list-group-item" style="text-decoration: none;">
                    <i class="fas fa-question-circle"></i> Help & Support
                </a>
            </div>
        </div>
    </main>
    
    <div id="complaint-fab" onclick="openComplaintModal()"><i class="fas fa-box-open"></i></div>

    <div class="modal-overlay" id="episode-modal"><div class="modal-content"><button class="modal-close" onclick="closeEpisodeModal()">&times;</button><h2 id="episode-modal-title">Episodes</h2><div id="episode-modal-list"></div></div></div>
    
    <div class="modal-overlay" id="request-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeRequestModal()">&times;</button>
            <h2 id="request-modal-title">Request a Movie</h2>
            <div id="request-modal-form">
                <div class="form-group">
                    <label for="request-movie-name">Movie Name</label>
                    <input type="text" id="request-movie-name" placeholder="e.g., The Dark Knight" required>
                </div>
                <div class="form-group">
                    <label for="request-movie-language">Language</label>
                    <input type="text" id="request-movie-language" placeholder="e.g., English">
                </div>
                <div class="form-group">
                    <label for="request-movie-year">Release Year</label>
                    <input type="number" id="request-movie-year" placeholder="e.g., 2008">
                </div>
                <button class="btn" onclick="submitMovieRequest()">Submit Request</button>
            </div>
        </div>
    </div>

    <!-- COUPON CODE MODAL -->
    <div class="modal-overlay" id="coupon-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeCouponModal()">&times;</button>
            <h2 id="coupon-modal-title">Redeem Coupon Code</h2>
            <div id="coupon-modal-body">
                <div class="form-group">
                    <label for="coupon-code-input">Enter your coupon code</label>
                    <input type="text" id="coupon-code-input" placeholder="XXXXXXX" maxlength="7" style="text-transform:uppercase">
                </div>
                <button class="btn" onclick="redeemCoupon()">Redeem</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="complaint-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeComplaintModal()">&times;</button>
            <h2 id="complaint-modal-title">Report an Issue</h2>
            <div id="complaint-modal-form" style="padding: 15px;">
                <div class="form-group">
                    <label for="complaint-movie-title">Movie/Series Title</label>
                    <input type="text" id="complaint-movie-title" placeholder="e.g., The Dark Knight" required>
                </div>
                <div class="form-group">
                    <label>Issue</label>
                    <p style="padding: 10px; background-color: rgba(255,255,255,0.1); border-radius: 5px;">Movie link is not working</p>
                </div>
                <button class="btn" onclick="submitComplaint()">Submit Report</button>
            </div>
        </div>
    </div>

    <!-- APP LOCK MANAGEMENT MODAL -->
    <div class="modal-overlay" id="app-lock-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeAppLockModal()">&times;</button>
            <h2 id="app-lock-modal-title" style="padding: 15px; border-bottom: 1px solid var(--border-color);">App Lock Settings</h2>
            <div style="padding: 15px;">
                <!-- View for setting a new PIN -->
                <div id="set-pin-view">
                    <div class="form-group">
                        <label for="new-pin">Create 4-Digit PIN</label>
                        <input type="password" id="new-pin" maxlength="4" inputmode="numeric" placeholder="Enter new PIN">
                    </div>
                    <div class="form-group">
                        <label for="confirm-pin">Confirm PIN</label>
                        <input type="password" id="confirm-pin" maxlength="4" inputmode="numeric" placeholder="Confirm new PIN">
                    </div>
                    <button class="btn" onclick="saveAppLockPin()">Save PIN</button>
                </div>
                <!-- View for changing or removing PIN -->
                <div id="manage-pin-view" style="display: none;">
                    <div class="form-group">
                        <label for="current-pin">Current PIN</label>
                        <input type="password" id="current-pin" maxlength="4" inputmode="numeric" placeholder="Enter current PIN to make changes">
                    </div>
                    <hr style="border-color: var(--border-color); margin: 20px 0;">
                    <div class="form-group">
                        <label for="change-new-pin">New PIN (Optional)</label>
                        <input type="password" id="change-new-pin" maxlength="4" inputmode="numeric" placeholder="Enter new PIN to change">
                    </div>
                    <div class="form-group">
                        <label for="change-confirm-pin">Confirm New PIN</label>
                        <input type="password" id="change-confirm-pin" maxlength="4" inputmode="numeric" placeholder="Confirm new PIN">
                    </div>
                    <div style="display: flex; gap: 10px; flex-direction: column;">
                        <button class="btn" onclick="saveAppLockPin()">Update PIN</button>
                        <button class="btn btn-secondary" style="background-color: #444;" onclick="removeAppLockPin()">Remove PIN</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- THEME SELECTOR MODAL -->
    <div class="modal-overlay" id="theme-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeThemeModal()">&times;</button>
            <h2 id="theme-modal-title">Select a Theme</h2>
            <div id="theme-selector-container">
                <div class="theme-preview-card" data-theme="filmzio-dark" onclick="applyTheme('filmzio-dark')">
                    <div class="theme-preview-mockup">
                        <div class="mockup-header"></div>
                        <div class="mockup-body">
                            <div class="mockup-card"></div><div class="mockup-card"></div><div class="mockup-card"></div>
                        </div>
                    </div>
                    <p class="theme-name">Filmzio Dark</p>
                </div>
                <div class="theme-preview-card" data-theme="classic-dark" onclick="applyTheme('classic-dark')">
                    <div class="theme-preview-mockup">
                        <div class="mockup-header"></div>
                        <div class="mockup-body">
                            <div class="mockup-card"></div><div class="mockup-card"></div><div class="mockup-card"></div>
                        </div>
                    </div>
                    <p class="theme-name">Classic Dark</p>
                </div>
                <div class="theme-preview-card" data-theme="gradient-luxe" onclick="applyTheme('gradient-luxe')">
                    <div class="theme-preview-mockup">
                        <div class="mockup-header"></div>
                        <div class="mockup-body">
                            <div class="mockup-card"></div><div class="mockup-card"></div><div class="mockup-card"></div>
                        </div>
                    </div>
                    <p class="theme-name">Gradient Luxe</p>
                </div>
                <div class="theme-preview-card" data-theme="minimal-light" onclick="applyTheme('minimal-light')">
                    <div class="theme-preview-mockup">
                        <div class="mockup-header"></div>
                        <div class="mockup-body">
                            <div class="mockup-card"></div><div class="mockup-card"></div><div class="mockup-card"></div>
                        </div>
                    </div>
                    <p class="theme-name">Minimal Light</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ICON SELECTOR MODAL -->
    <div class="modal-overlay" id="icon-selector-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeIconSelectorModal()">&times;</button>
            <h2 id="icon-selector-title">Choose Your Icon</h2>
            <div id="icon-choices">
                <button class="icon-choice-btn" onclick="selectProfileIcon('male')">
                    <i class="fas fa-mars"></i>
                    <span>Male</span>
                </button>
                <button class="icon-choice-btn" onclick="selectProfileIcon('female')">
                    <i class="fas fa-venus"></i>
                    <span>Female</span>
                </button>
                <button class="icon-choice-btn" onclick="selectProfileIcon('default')">
                    <i class="fas fa-user-astronaut"></i>
                    <span>Default</span>
                </button>
            </div>
        </div>
    </div>


    <div class="modal-overlay" id="privacy-policy-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closePrivacyPolicyModal()">&times;</button>
            <h2 id="privacy-policy-title">Privacy Policy</h2>
            <div id="privacy-policy-content">
                <p><strong>Last Updated: [Date]</strong></p>
                <p>Welcome to NH BOX. Your privacy is important to us. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you use our application.</p>
                <h3>Information We Collect</h3>
                <p>We may collect information about you in a variety of ways. The information we may collect on the App includes:</p>
                <p><strong>Personal Data:</strong> When you register, you provide us with your name. This is the only personally identifiable information we store. Your name is used to personalize your experience and for features like comments and movie requests.</p>
                <p><strong>Usage Data:</strong> We automatically collect certain information when you access the App, such as your watch history and watchlist. This data is linked to your user account to provide you with these features and is not shared with third parties.</p>
                <h3>Use of Your Information</h3>
                <p>Having accurate information permits us to provide you with a smooth, efficient, and customized experience. Specifically, we may use information collected about you via the App to:</p>
                <ul>
                    <li>Create and manage your account.</li>
                    <li>Provide you with app features like watch history and watchlist.</li>
                    <li>Enable user-to-user communications (e.g., comments).</li>
                    <li>Fulfill and manage movie requests.</li>
                </ul>
                <h3>Disclosure of Your Information</h3>
                <p>We do not sell, trade, or rent your personal identification information to others. All data you provide is used solely for the functionality of the NH BOX app.</p>
                <h3>Security of Your Information</h3>
                <p>We use administrative, technical, and physical security measures to help protect your personal information. While we have taken reasonable steps to secure the personal information you provide to us, please be aware that despite our efforts, no security measures are perfect or impenetrable, and no method of data transmission can be guaranteed against any interception or other type of misuse.</p>
                <h3>Contact Us</h3>
                <p>If you have questions or comments about this Privacy Policy, please contact us through the "Help & Support" link in the app.</p>
            </div>
        </div>
    </div>
    
    <!-- VIDEO PLAYER USES AN IFRAME -->
    <div class="video-player" id="video-player">
        <div class="video-controls">
            <button class="video-close" onclick="closeVideoPlayer()"><i class="fas fa-times"></i></button>
        </div>
        <iframe id="video-iframe" style="width:100%; height:100%;" frameborder="0" allowfullscreen></iframe>
    </div>

    <div class="cast-full-view" id="cast-full-view"><button class="cast-full-close" onclick="closeCastFullView()"><i class="fas fa-times"></i></button><img id="cast-full-image" src="" alt=""><div id="cast-full-name" class="cast-full-name"></div></div>
    
    <!-- SERIES PLAYER USES AN IFRAME -->
    <div class="modal-overlay" id="series-player-modal">
        <div class="series-player-content">
            <div class="video-controls" style="top: auto; bottom: calc(100% - 60px); right: 10px;">
                <button class="modal-close series-player-close" style="position: static;" onclick="closeSeriesPlayer()">&times;</button>
            </div>
            <div class="series-video-container">
                <iframe id="series-iframe" style="width:100%; height:100%;" frameborder="0" allowfullscreen></iframe>
            </div>
            <div class="series-episode-list-container" id="series-episode-list"></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="upcoming-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeUpcomingModal()">&times;</button>
            <img id="upcoming-modal-poster" src="" alt="Poster">
            <h2 id="upcoming-modal-title">Movie Title</h2>
            <p id="upcoming-modal-release-date">Releasing on: DATE</p>
            <div id="upcoming-modal-countdown">
                <div class="countdown-item"><div id="countdown-days" class="countdown-number">00</div><div class="countdown-label">Days</div></div>
                <div class="countdown-item"><div id="countdown-hours" class="countdown-number">00</div><div class="countdown-label">Hours</div></div>
                <div class="countdown-item"><div id="countdown-mins" class="countdown-number">00</div><div class="countdown-label">Mins</div></div>
                <div class="countdown-item"><div id="countdown-secs" class="countdown-number">00</div><div class="countdown-label">Secs</div></div>
            </div>
        </div>
    </div>

    <div id="ad-overlay">
        <div class="ad-container">
            <div class="ad-header">
                <span id="ad-countdown-text">Advertisement</span>
                <button id="ad-skip-btn" style="display: none;">Skip Ad</button>
            </div>
            <iframe id="ad-iframe" src="" frameborder="0" scrolling="no"></iframe>
        </div>
    </div>
    
    <button id="install-pwa-btn"><i class="fas fa-download"></i> Install App</button>

    <div id="poll-popup" style="display: none;">
        <div id="poll-header">
            <i class="fas fa-poll"></i> <span>Quick Poll</span>
            <button id="poll-close-btn" onclick="closePollPopup()">&times;</button>
        </div>
        <div id="poll-content">
            <p id="poll-question"></p>
            <div id="poll-options-container"></div>
            <button id="poll-vote-btn" class="btn">Vote</button>
        </div>
    </div>

    <div class="modal-overlay" id="request-notification-popup" style="z-index: 10000;">
        <div class="modal-content" style="max-width: 320px; text-align: center; padding: 20px;">
            <h2 style="font-size: 20px; color: var(--primary-color); margin-bottom: 15px;">Request Fulfilled!</h2>
            <img id="notification-poster" src="" alt="Movie Poster" style="width: 150px; height: auto; border-radius: 8px; margin-bottom: 15px;">
            <p id="notification-message" style="margin-bottom: 20px; line-height: 1.5;"></p>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button id="notification-watch-btn" class="btn">Watch Now</button>
                <button id="notification-dismiss-btn" class="btn btn-secondary" style="background-color: #444;">Dismiss</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="maintenance-popup" style="z-index: 10001;">
        <div class="modal-content" style="max-width: 320px; text-align: center; padding: 25px;">
            <i class="fas fa-tools" style="font-size: 40px; color: var(--primary-color); margin-bottom: 20px;"></i>
            <h2 style="font-size: 20px; margin-bottom: 10px;">Under Maintenance</h2>
            <p style="color: var(--secondary-text-color); margin-bottom: 25px;">
                This movie is temporarily unavailable. Please check back later.
            </p>
            <button class="btn" onclick="closeMaintenancePopup()">OK</button>
        </div>
    </div>

    <div class="modal-overlay" id="live-request-modal">
        <div class="modal-content" style="max-width: 320px; text-align: center; padding: 25px;">
            <button class="modal-close" onclick="closeLiveRequestModal()">&times;</button>
            <i class="fas fa-satellite-dish" style="font-size: 40px; color: var(--primary-color); margin-bottom: 20px;"></i>
            <h2 style="font-size: 20px; margin-bottom: 10px;">We're Live!</h2>
            <p style="color: var(--secondary-text-color); margin-bottom: 25px;">
                Now is a great time to send your movie requests from your profile page. We're actively checking them!
            </p>
            <button class="btn" onclick="closeLiveRequestModalAndGoToProfile()">Go to Profile</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="age-verification-modal">
        <div class="modal-content" style="max-width: 320px; text-align: center; padding: 25px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 40px; color: var(--primary-color); margin-bottom: 20px;"></i>
            <h2 style="font-size: 20px; margin-bottom: 10px;">Age Verification Required</h2>
            <p style="color: var(--secondary-text-color); margin-bottom: 25px;">
                This content is restricted. Please confirm you are 18 years of age or older to request access.
            </p>
            <div style="display: flex; gap: 10px;">
                 <button class="btn" id="age-confirm-btn">Yes, I am over 18</button>
                 <button class="btn btn-secondary" onclick="closeAgeVerificationModal()">No, take me back</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="checkout-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeCheckoutModal()">&times;</button>
            <h2 id="checkout-modal-title">Complete Your Purchase</h2>
            <div id="checkout-modal-body">
                <p style="text-align: center; margin-bottom: 15px;">Scan the QR code to pay. After payment, enter the Transaction ID below to complete your request.</p>
                <img id="checkout-qr-code" src="" alt="Payment QR Code">
                <div class="form-group">
                    <label for="checkout-transaction-id">Transaction ID / Ref ID</label>
                    <input type="text" id="checkout-transaction-id" placeholder="Enter the transaction ID from your app" required>
                </div>
                <div class="form-group">
                    <label for="checkout-utr-id">UTR ID (Optional)</label>
                    <input type="text" id="checkout-utr-id" placeholder="Enter UTR ID if available">
                </div>
                <button class="btn" id="checkout-send-btn">Send for Review</button>
            </div>
        </div>
    </div>


    <nav class="bottom-nav" id="bottom-nav" style="display: none;">
        <div class="nav-item active" onclick="navigateTo('home-page')"><i class="fas fa-home"></i><span>Home</span></div>
        <div class="nav-item" onclick="navigateTo('movies-page')"><i class="fas fa-film"></i><span>Movies</span></div>
        <div class="nav-item" onclick="navigateTo('series-page')"><i class="fas fa-plus-square"></i><span>Series</span></div>
        <div class="nav-item" onclick="navigateTo('livetv-page')"><i class="fas fa-tv"></i><span>Live TV</span></div>
        <div class="nav-item" onclick="navigateTo('profile-page')"><i class="fas fa-user"></i><span>Profile</span></div>
    </nav>

    <script>
        // !!! IMPORTANT: REPLACE WITH YOUR FIREBASE PROJECT CONFIGURATION !!!
        const firebaseConfig = {
          apiKey: "AIzaSyCvvinyI_PyKvm8uVfA2W2udgQbFpprU20",
          authDomain: "qentaitoons.firebaseapp.com",
          databaseURL: "https://qentaitoons-default-rtdb.firebaseio.com",
          projectId: "qentaitoons",
          storageBucket: "qentaitoons.appspot.com",
          messagingSenderId: "253651614590",
          appId: "1:253651614590:web:58ab4b66754ef2cff7912f",
          measurementId: "G-KD9YMM6PWM"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let allContent = [], currentContent = null, sliderInterval = null, currentSlide = 0, currentUser = null, previousPageId = 'home-page';
        let countdownInterval = null;
        let validityCountdownInterval = null; // For profile validity timer
        let maintenanceCountdownInterval = null;
        let currentFilters = { searchTerm: '' };
        let isNavigating = false;
        let activePoll = { id: null, data: null };
        let onAdCompleteCallback = null;
        let hls = null; 
        let subscriptionPlans = {};
        let appSettings = {};
        let enteredPin = '';
        
        document.addEventListener('DOMContentLoaded', () => {
            // --- Theme Loader ---
            const savedTheme = localStorage.getItem('nh_box_theme') || 'filmzio-dark';
            applyTheme(savedTheme);

            loadAppSettings(); // Load settings early for logo display
            listenForServerStatus(); 
            checkLogin();
            document.getElementById('search-input').addEventListener('input', (e) => {
                currentFilters.searchTerm = e.target.value;
                filterContent();
            });
            document.getElementById('enter-btn').addEventListener('click', proceedToApp);
        });

        // --- START: THEME FUNCTIONS ---
        function openThemeModal() {
            document.getElementById('theme-modal').style.display = 'flex';
        }

        function closeThemeModal() {
            document.getElementById('theme-modal').style.display = 'none';
        }

        function applyTheme(themeName) {
            document.body.dataset.theme = themeName;
            localStorage.setItem('nh_box_theme', themeName);
            
            document.querySelectorAll('.theme-preview-card').forEach(card => {
                card.classList.remove('active');
            });
            const activeCard = document.querySelector(`.theme-preview-card[data-theme="${themeName}"]`);
            if (activeCard) {
                activeCard.classList.add('active');
            }

            // Update PWA theme color meta tag
            const themeColor = getComputedStyle(document.body).getPropertyValue('--primary-color').trim();
            document.querySelector('meta[name="theme-color"]').setAttribute('content', themeColor);
        }
        // --- END: THEME FUNCTIONS ---
        
        // --- START: Server Management Listener ---
        function listenForServerStatus() {
            const overlay = document.getElementById('server-maintenance-overlay');
            const titleEl = document.getElementById('maintenance-title');
            const messageEl = document.getElementById('maintenance-message');
            const countdownEl = document.getElementById('maintenance-countdown-timer');

            database.ref('serverManagement').on('value', snapshot => {
                if (maintenanceCountdownInterval) clearInterval(maintenanceCountdownInterval);
                
                if (!snapshot.exists() || !snapshot.val() || snapshot.val().status === 'LIVE') {
                    overlay.style.display = 'none';
                    return;
                }

                const config = snapshot.val();
                const now = Date.now();

                if (config.status === 'MAINTENANCE') {
                    titleEl.textContent = 'Under Maintenance';
                    messageEl.textContent = "The app is currently down for maintenance. We'll be back shortly. Thank you for your patience!";
                    countdownEl.style.display = 'none';
                    overlay.style.display = 'flex';
                } else if (config.status === 'SCHEDULED' && config.scheduledEnd > now && config.scheduledStart < now) {
                    titleEl.textContent = 'Scheduled Maintenance';
                    messageEl.textContent = 'The app is temporarily down for a scheduled update. We will be back online soon:';
                    countdownEl.style.display = 'flex';
                    overlay.style.display = 'flex';

                    const updateCountdown = () => {
                        const distance = config.scheduledEnd - Date.now();
                        if (distance < 0) {
                            clearInterval(maintenanceCountdownInterval);
                            countdownEl.style.display = 'none';
                            messageEl.textContent = 'Maintenance is complete. The app should be back online shortly.';
                            return;
                        }
                        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                        document.getElementById('m-countdown-days').textContent = String(days).padStart(2, '0');
                        document.getElementById('m-countdown-hours').textContent = String(hours).padStart(2, '0');
                        document.getElementById('m-countdown-mins').textContent = String(minutes).padStart(2, '0');
                        document.getElementById('m-countdown-secs').textContent = String(seconds).padStart(2, '0');
                    };
                    updateCountdown();
                    maintenanceCountdownInterval = setInterval(updateCountdown, 1000);
                } else {
                    // This covers expired schedules or invalid data
                    overlay.style.display = 'none';
                }
            });
        }
        // --- END: Server Management Listener ---


        let deferredPrompt;
        const installButton = document.getElementById('install-pwa-btn');

        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installButton.style.display = 'block'; });
        installButton.addEventListener('click', async () => { if (deferredPrompt) { deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; console.log(`User response to install prompt: ${outcome}`); deferredPrompt = null; installButton.style.display = 'none'; } });
        window.addEventListener('appinstalled', () => { deferredPrompt = null; installButton.style.display = 'none'; });

        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').then(reg => console.log('SW registered.')).catch(err => console.log('SW registration failed: ', err)); }); }
        
        async function checkLogin() {
            let user = localStorage.getItem('nh_box_user');
            if (user) {
                const storedUser = JSON.parse(user);
                const userSnapshot = await database.ref('users/' + storedUser.id).once('value');
                if (userSnapshot.exists()) {
                    currentUser = { id: userSnapshot.key, ...userSnapshot.val() };
                    localStorage.setItem('nh_box_user', JSON.stringify(currentUser)); 
                    setupAppLock(); 
                } else {
                    handleLogout();
                }
            } else {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('login-page').style.display = 'flex';
            }
        }

        function handleLogin() {
            const name = document.getElementById('login-name').value.trim();
            if (name.length < 3) { alert('Please enter a valid name.'); return; }
            const userRef = database.ref('users').push();
            const newUser = {
                id: userRef.key,
                name: name,
                createdAt: Date.now(),
                isVerified: false
            };
            userRef.set(newUser).then(() => {
                currentUser = newUser;
                localStorage.setItem('nh_box_user', JSON.stringify(newUser));
                document.getElementById('login-page').style.display = 'none';
                setupAppLock();
            });
        }

        function handleLogout() { 
            if (validityCountdownInterval) { clearInterval(validityCountdownInterval); }
            localStorage.removeItem('nh_box_user'); 
            localStorage.removeItem('nh_box_app_pin'); 
            localStorage.removeItem('nh_box_profile_icon'); 
            window.location.reload(); 
        }
        
        function initializeApp() {
            document.getElementById('disclaimer-overlay').style.display = 'flex';
            document.getElementById('bottom-nav').style.display = 'flex';
            document.getElementById('complaint-fab').style.display = 'flex';
            setupProfilePage();
            updateProfileAppLockText();
        }

        // MODIFIED: Central function for app settings
        function loadAppSettings() {
            database.ref('settings').on('value', snapshot => {
                appSettings = snapshot.val() || {};
                
                // Update Logo
                const logoText = appSettings.logoText || 'FILMZIO';
                document.getElementById('header-logo').innerHTML = `${logoText}<i class="fas fa-film"></i>`;
                document.getElementById('loading-logo').innerHTML = `${logoText}<i class="fas fa-film"></i>`;
                document.getElementById('login-logo').innerHTML = `${logoText}<i class="fas fa-film"></i>`;
                document.getElementById('id-card-logo').innerHTML = `${logoText}<i class="fas fa-film"></i>`;

                // Update support link (if user is logged in)
                if (currentUser) {
                    setupProfilePage();
                }
            });
        }

        function proceedToApp() {
            document.getElementById('disclaimer-overlay').style.display = 'none';
            document.getElementById('loading-screen').style.display = 'none';
            loadContent();
            loadUpcoming();
            loadLiveTvChannels();
            fetchActivePoll();
            // loadRequestMarquee(); // This element was removed in the new UI
            listenForNotifications();
            listenForLiveStatus();
            loadSubscriptionPlans();
            navigateTo('home-page');
        }
        
        // --- START: App Lock Functions ---
        function setupAppLock() {
            const storedPin = localStorage.getItem('nh_box_app_pin');
            if (storedPin) {
                showAppLockScreen();
            } else {
                initializeApp();
            }
        }

        function showAppLockScreen() {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('app-lock-overlay').style.display = 'flex';
        }

        function handlePinInput(digit) {
            if (enteredPin.length < 4) {
                enteredPin += digit;
                updatePinDisplay();
            }
            if (enteredPin.length === 4) {
                verifyPin();
            }
        }
        
        function handlePinBackspace() {
            enteredPin = enteredPin.slice(0, -1);
            updatePinDisplay();
        }

        function updatePinDisplay() {
            const dots = document.querySelectorAll('.pin-dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('filled', index < enteredPin.length);
            });
        }
        
        function hashPin(pin) {
             // This is a simple obfuscation, not a secure hash. Suitable for this purpose.
             return btoa(pin.split('').reverse().join('') + 'NH_BOX_SALT');
        }

        function verifyPin() {
            const storedPin = localStorage.getItem('nh_box_app_pin');
            if (hashPin(enteredPin) === storedPin) {
                unlockApp();
            } else {
                const container = document.getElementById('app-lock-container');
                container.classList.add('shake');
                setTimeout(() => {
                    container.classList.remove('shake');
                    enteredPin = '';
                    updatePinDisplay();
                }, 500);
            }
        }

        function unlockApp() {
            document.getElementById('app-lock-overlay').style.display = 'none';
            initializeApp(); // Now that it's unlocked, initialize the main app.
        }

        function openAppLockModal() {
            const setView = document.getElementById('set-pin-view');
            const manageView = document.getElementById('manage-pin-view');
            
            // Clear all fields when opening
            document.getElementById('new-pin').value = '';
            document.getElementById('confirm-pin').value = '';
            document.getElementById('current-pin').value = '';
            document.getElementById('change-new-pin').value = '';
            document.getElementById('change-confirm-pin').value = '';

            if (localStorage.getItem('nh_box_app_pin')) {
                setView.style.display = 'none';
                manageView.style.display = 'block';
            } else {
                setView.style.display = 'block';
                manageView.style.display = 'none';
            }
            document.getElementById('app-lock-modal').style.display = 'flex';
        }

        function closeAppLockModal() {
            document.getElementById('app-lock-modal').style.display = 'none';
        }
        
        function updateProfileAppLockText() {
            const textEl = document.getElementById('app-lock-profile-text');
            if (localStorage.getItem('nh_box_app_pin')) {
                textEl.textContent = 'Manage App Lock';
            } else {
                textEl.textContent = 'Set App Lock';
            }
        }

        function saveAppLockPin() {
            const isChanging = !!localStorage.getItem('nh_box_app_pin');
            let newPin, confirmPin, currentPin;

            if (isChanging) {
                newPin = document.getElementById('change-new-pin').value;
                confirmPin = document.getElementById('change-confirm-pin').value;
                currentPin = document.getElementById('current-pin').value;
                
                if (hashPin(currentPin) !== localStorage.getItem('nh_box_app_pin')) {
                    alert('Incorrect current PIN.');
                    return;
                }
            } else {
                newPin = document.getElementById('new-pin').value;
                confirmPin = document.getElementById('confirm-pin').value;
            }

            if (newPin.length !== 4) {
                alert('PIN must be 4 digits.');
                return;
            }
            if (newPin !== confirmPin) {
                alert('New PINs do not match.');
                return;
            }

            localStorage.setItem('nh_box_app_pin', hashPin(newPin));
            alert('App Lock PIN has been saved successfully!');
            updateProfileAppLockText();
            closeAppLockModal();
        }

        function removeAppLockPin() {
            const currentPin = document.getElementById('current-pin').value;
            if (hashPin(currentPin) !== localStorage.getItem('nh_box_app_pin')) {
                alert('Incorrect PIN. Cannot remove App Lock.');
                return;
            }
            if (confirm("Are you sure you want to remove the App Lock PIN?")) {
                localStorage.removeItem('nh_box_app_pin');
                alert('App Lock has been removed.');
                updateProfileAppLockText();
                closeAppLockModal();
            }
        }
        // --- END: App Lock Functions ---

        // --- START: Profile Icon Selector Functions ---
        function openIconSelectorModal() {
            document.getElementById('icon-selector-modal').style.display = 'flex';
        }

        function closeIconSelectorModal() {
            document.getElementById('icon-selector-modal').style.display = 'none';
        }

        function selectProfileIcon(iconType) {
            localStorage.setItem('nh_box_profile_icon', iconType);
            updateProfileIcon();
            closeIconSelectorModal();
        }

        function updateProfileIcon() {
            const iconContainer = document.getElementById('id-card-photo');
            const iconType = localStorage.getItem('nh_box_profile_icon');
            
            switch(iconType) {
                case 'male':
                    iconContainer.innerHTML = '<i class="fas fa-mars"></i>';
                    break;
                case 'female':
                    iconContainer.innerHTML = '<i class="fas fa-venus"></i>';
                    break;
                default:
                    const emojis = ['', '', '', '', '', '', '', '', '', ''];
                    iconContainer.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            }
        }
        // --- END: Profile Icon Selector Functions ---

        function isUserSubscribed() {
            if (!currentUser || !currentUser.subscription) {
                return false;
            }
            const now = Date.now();
            return currentUser.subscription.expiresAt > now;
        }

        function listenForLiveStatus() {
            const liveIndicator = document.getElementById('live-indicator');
            database.ref('liveStatus/isLive').on('value', snapshot => {
                liveIndicator.style.display = snapshot.val() === true ? 'flex' : 'none';
            });
        }

        function showLiveRequestModal() { document.getElementById('live-request-modal').style.display = 'flex'; }
        function closeLiveRequestModal() { document.getElementById('live-request-modal').style.display = 'none'; }
        function closeLiveRequestModalAndGoToProfile() { closeLiveRequestModal(); navigateTo('profile-page'); }

        async function handleContentClick(itemId) {
            const item = allContent.find(c => c.id === itemId);
            if (!item) return;

            if (item.category === '18+ Movie' && (!currentUser || !currentUser.isVerified)) {
                const requestSnapshot = await database.ref('verificationRequests/' + currentUser.id).once('value');
                if (requestSnapshot.exists()) {
                    alert("Your verification request is pending admin approval. Please wait.");
                } else {
                    showAgeVerificationModal();
                }
                return;
            }

            if (item.type === 'movie' && item.maintenance === true) {
                showMaintenancePopup();
            } else {
                showDetail(item);
            }
        }

        function showAgeVerificationModal() {
            document.getElementById('age-verification-modal').style.display = 'flex';
            document.getElementById('age-confirm-btn').onclick = () => submitVerificationRequest();
        }

        function closeAgeVerificationModal() {
            document.getElementById('age-verification-modal').style.display = 'none';
        }

        async function submitVerificationRequest() {
            if (!currentUser) return;
            const requestSnapshot = await database.ref('verificationRequests/' + currentUser.id).once('value');
            if (requestSnapshot.exists()) {
                alert("You have already submitted a request. It is pending admin approval.");
                closeAgeVerificationModal();
                return;
            }
            const requestData = { name: currentUser.name, timestamp: firebase.database.ServerValue.TIMESTAMP };
            database.ref('verificationRequests/' + currentUser.id).set(requestData)
                .then(() => {
                    alert("Your request for 18+ access has been sent to the admin for approval.");
                    closeAgeVerificationModal();
                })
                .catch(error => {
                    alert("Error sending request. Please try again.");
                });
        }

        function showMaintenancePopup() { document.getElementById('maintenance-popup').style.display = 'flex'; }
        function closeMaintenancePopup() { document.getElementById('maintenance-popup').style.display = 'none'; }

        function listenForNotifications() {
            const notificationsRef = database.ref('notifications').orderByChild('timestamp').limitToLast(1);
            notificationsRef.on('child_added', async (snapshot) => {
                if (!snapshot.exists()) return;
                const notificationId = snapshot.key;
                const notificationData = snapshot.val();
                const seenRef = database.ref(`users/${currentUser.id}/seenNotifications/${notificationId}`);
                const seenSnapshot = await seenRef.once('value');
                if (!seenSnapshot.exists()) {
                    showRequestNotification(notificationData, notificationId);
                }
            });
        }

        function showRequestNotification(data, id) {
            const popup = document.getElementById('request-notification-popup');
            if (!popup) return;
            document.getElementById('notification-poster').src = data.poster;
            document.getElementById('notification-message').textContent = data.message;
            const watchBtn = document.getElementById('notification-watch-btn');
            const dismissBtn = document.getElementById('notification-dismiss-btn');
            watchBtn.onclick = () => {
                const content = allContent.find(item => item.id === data.contentId);
                if (content) { showDetail(content); }
                closeRequestNotification();
                markNotificationAsSeen(id);
            };
            dismissBtn.onclick = () => {
                closeRequestNotification();
                markNotificationAsSeen(id);
            };
            popup.style.display = 'flex';
        }

        function closeRequestNotification() { document.getElementById('request-notification-popup').style.display = 'none'; }
        function markNotificationAsSeen(notificationId) { if (!currentUser || !notificationId) return; database.ref(`users/${currentUser.id}/seenNotifications/${notificationId}`).set(true); }
        
        function setupProfilePage() { 
            if (!currentUser) return; 
            
            if (validityCountdownInterval) {
                clearInterval(validityCountdownInterval);
                validityCountdownInterval = null;
            }

            const joinDate = new Date(currentUser.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long' }); 
            document.getElementById('id-card-name').textContent = currentUser.name;
            document.getElementById('id-card-member-since').textContent = `MEMBER SINCE: ${joinDate}`;
            const userIdDisplay = `NHB-${currentUser.createdAt.toString().slice(-6)}-${currentUser.id.slice(0, 4).toUpperCase()}`;
            document.getElementById('id-card-user-id').textContent = `ID: ${userIdDisplay}`;
            
            updateProfileIcon();
            
            const subStatusCardEl = document.getElementById('id-card-subscription');
            const supportLinkItem = document.getElementById('customer-support-link-item');
            const timerEl = document.getElementById('id-card-timer');
            const daysEl = document.getElementById('validity-days');
            const hoursEl = document.getElementById('validity-hours');
            const minsEl = document.getElementById('validity-mins');
            const secsEl = document.getElementById('validity-secs');

            if (isUserSubscribed()) {
                const planText = `${currentUser.subscription.planName} Plan`;
                subStatusCardEl.textContent = planText;
                subStatusCardEl.className = `id-card-subscription ${currentUser.subscription.planName.toUpperCase()}`;
                timerEl.classList.remove('blinking');

                const updateCountdown = () => {
                    const now = new Date().getTime();
                    const distance = currentUser.subscription.expiresAt - now;

                    if (distance < 0) {
                        clearInterval(validityCountdownInterval);
                        daysEl.textContent = '00';
                        hoursEl.textContent = '00';
                        minsEl.textContent = '00';
                        secsEl.textContent = '00';
                        timerEl.classList.add('blinking');
                        subStatusCardEl.textContent = 'Free Member';
                        subStatusCardEl.className = 'id-card-subscription';
                        return;
                    }
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    daysEl.textContent = String(days).padStart(2, '0');
                    hoursEl.textContent = String(hours).padStart(2, '0');
                    minsEl.textContent = String(minutes).padStart(2, '0');
                    secsEl.textContent = String(seconds).padStart(2, '0');
                };
                updateCountdown();
                validityCountdownInterval = setInterval(updateCountdown, 1000);

                if (appSettings.supportLink && supportLinkItem) {
                    supportLinkItem.href = appSettings.supportLink;
                    const icon = supportLinkItem.querySelector('i');
                    if (appSettings.supportLink.includes('whatsapp.com')) { icon.className = 'fab fa-whatsapp'; } 
                    else if (appSettings.supportLink.includes('t.me') || appSettings.supportLink.includes('telegram.org')) { icon.className = 'fab fa-telegram-plane'; }
                    else { icon.className = 'fas fa-headset'; }
                    supportLinkItem.style.display = 'flex';
                } else if (supportLinkItem) {
                    supportLinkItem.style.display = 'none';
                }
            } else {
                subStatusCardEl.textContent = 'Free Member';
                subStatusCardEl.className = 'id-card-subscription';
                daysEl.textContent = '00';
                hoursEl.textContent = '00';
                minsEl.textContent = '00';
                secsEl.textContent = '00';
                timerEl.classList.add('blinking');
                if (supportLinkItem) { supportLinkItem.style.display = 'none'; }
            }
        }
        
        function navigateTo(pageId) {
            if (isNavigating) return;
            const outgoingPage = document.querySelector('.page.active');
            const incomingPage = document.getElementById(pageId);
            
            if (outgoingPage && outgoingPage.id === 'profile-page') {
                if (validityCountdownInterval) {
                    clearInterval(validityCountdownInterval);
                    validityCountdownInterval = null;
                }
            }
            if (pageId === 'profile-page') {
                setupProfilePage(); 
            }
             if (pageId === 'movies-page') {
                populateMoviesPage();
            }
            if (pageId === 'series-page') {
                populateSeriesPage();
            }
            
            if (!incomingPage || (outgoingPage && outgoingPage.id === pageId)) return;
            isNavigating = true;
            if (outgoingPage && outgoingPage.id === 'detail-page') { stopStorylineAudio(); }
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const activeNavItem = document.querySelector(`.nav-item[onclick="navigateTo('${pageId}')"]`);
            if (activeNavItem) activeNavItem.classList.add('active');
            const topLevelPages = ['home-page', 'watchlist-page', 'upcoming-page', 'profile-page', 'livetv-page', 'movies-page', 'series-page'];
            document.getElementById('back-btn').style.display = topLevelPages.includes(pageId) ? 'none' : 'block';
            if (pageId === 'watchlist-page') loadWatchlist();
            if (sliderInterval && pageId !== 'home-page') clearInterval(sliderInterval);
            if (pageId === 'home-page') startSlider();
            if (outgoingPage) { previousPageId = outgoingPage.id; outgoingPage.classList.remove('active'); outgoingPage.classList.add('exit'); outgoingPage.addEventListener('transitionend', function onExit() { this.classList.remove('exit'); this.removeEventListener('transitionend', onExit); }, { once: true }); }
            incomingPage.classList.add('active');
            incomingPage.scrollTop = 0;
            setTimeout(() => { isNavigating = false; }, 700);
        }
        
        function goBack() { stopStorylineAudio(); navigateTo(previousPageId); }
        function playStorylineAudio(text) { if ('speechSynthesis' in window) { stopStorylineAudio(); const utterance = new SpeechSynthesisUtterance(text); const voices = window.speechSynthesis.getVoices(); const hindiVoice = voices.find(voice => voice.lang === 'hi-IN'); if (hindiVoice) { utterance.voice = hindiVoice; } utterance.lang = 'hi-IN'; window.speechSynthesis.speak(utterance); } }
        function stopStorylineAudio() { if ('speechSynthesis' in window && window.speechSynthesis.speaking) { window.speechSynthesis.cancel(); } }
        if ('speechSynthesis' in window) { window.speechSynthesis.onvoiceschanged = () => { window.speechSynthesis.getVoices(); }; }
        
        function openRequestModal() { document.getElementById('request-modal').style.display = 'flex'; }
        function closeRequestModal() { document.getElementById('request-modal').style.display = 'none'; }
        function openPrivacyPolicyModal() { document.getElementById('privacy-policy-modal').style.display = 'flex'; }
        function closePrivacyPolicyModal() { document.getElementById('privacy-policy-modal').style.display = 'none'; }
        function openComplaintModal() { if (currentContent && document.getElementById('detail-page').classList.contains('active')) { document.getElementById('complaint-movie-title').value = currentContent.title; } else { document.getElementById('complaint-movie-title').value = ''; } document.getElementById('complaint-modal').style.display = 'flex'; }
        function closeComplaintModal() { document.getElementById('complaint-modal').style.display = 'none'; }

        async function submitMovieRequest() {
            const movieName = document.getElementById('request-movie-name').value.trim();
            const language = document.getElementById('request-movie-language').value.trim();
            const year = document.getElementById('request-movie-year').value.trim();
            if (!movieName) { alert('Please enter a movie name.'); return; }
            const requestsRef = database.ref('requests');
            const userRequestsSnapshot = await requestsRef.orderByChild('userId').equalTo(currentUser.id).once('value');
            if (userRequestsSnapshot.numChildren() >= 3) { alert("You have reached your maximum limit of 3 movie requests."); return; }
            const requestData = { movieName, language, year, requestedBy: currentUser.name, userId: currentUser.id, timestamp: firebase.database.ServerValue.TIMESTAMP };
            database.ref('requests').push(requestData).then(() => { alert('Your request has been submitted successfully!'); closeRequestModal(); document.getElementById('request-movie-name').value = ''; document.getElementById('request-movie-language').value = ''; document.getElementById('request-movie-year').value = ''; }).catch(error => alert(`Error: ${error.message}`));
        }
        
        function submitComplaint() { const movieTitle = document.getElementById('complaint-movie-title').value.trim(); if (!movieTitle) { alert('Please enter the movie or series title.'); return; } const reportedContent = allContent.find(item => item.title.toLowerCase() === movieTitle.toLowerCase()); if (!reportedContent) { alert('Could not find that content. Please check the title.'); return; } const complaintData = { movieTitle: reportedContent.title, contentId: reportedContent.id, contentType: reportedContent.type, issue: "Movie link not working", reportedBy: currentUser.name, userId: currentUser.id, timestamp: firebase.database.ServerValue.TIMESTAMP }; database.ref('complaints').push(complaintData).then(() => { alert('Your report has been submitted. Thank you!'); closeComplaintModal(); }).catch(error => alert(`Error: ${error.message}`)); }
        
        function loadContent() { database.ref('webseries').on('value', wsSnapshot => { const webseries = []; wsSnapshot.forEach(child => { webseries.push({ id: child.key, ...child.val() }); }); database.ref('movies').on('value', mSnapshot => { const movies = []; mSnapshot.forEach(child => { movies.push({ id: child.key, ...child.val() }); }); allContent = [...webseries, ...movies].sort((a, b) => b.timestamp - a.timestamp); updateSlider(); updateTrendingSection(); filterContent(); }); }); }
        
        function loadUpcoming() { const grid = document.getElementById('upcoming-grid'); const placeholder = document.getElementById('upcoming-placeholder'); database.ref('upcoming').on('value', snapshot => { grid.innerHTML = ''; if (!snapshot.exists()) { placeholder.style.display = 'block'; return; } placeholder.style.display = 'none'; snapshot.forEach(child => { const item = { id: child.key, ...child.val() }; const card = document.createElement('div'); card.className = 'content-card'; const languageBadge = item.language ? `<span class="content-language-badge">${item.language}</span>` : ''; card.innerHTML = `${languageBadge}<img src="${item.poster}" alt="${item.title}"><div class="content-title">${item.title}</div>`; card.onclick = () => openUpcomingModal(item); grid.appendChild(card); }); }); }
        function fetchActivePoll() { database.ref('polls').orderByChild('createdAt').limitToLast(1).once('value', snapshot => { if (snapshot.exists()) { snapshot.forEach(child => { activePoll.id = child.key; activePoll.data = child.val(); }); checkIfUserVoted(); } }); }
        function checkIfUserVoted() { if (!currentUser || !activePoll.id) return; database.ref(`users/${currentUser.id}/votedPolls/${activePoll.id}`).once('value', snapshot => { if (!snapshot.exists()) { displayPollPopup(); } }); }
        function displayPollPopup() { const popup = document.getElementById('poll-popup'); document.getElementById('poll-question').textContent = activePoll.data.question; const optionsContainer = document.getElementById('poll-options-container'); optionsContainer.innerHTML = ''; Object.keys(activePoll.data.options).forEach(optionText => { const optionEl = document.createElement('div'); optionEl.className = 'poll-option'; optionEl.textContent = optionText; optionEl.dataset.option = optionText; optionEl.onclick = () => { document.querySelectorAll('.poll-option').forEach(opt => opt.classList.remove('selected')); optionEl.classList.add('selected'); }; optionsContainer.appendChild(optionEl); }); document.getElementById('poll-vote-btn').onclick = submitVote; popup.style.display = 'block'; }
        function submitVote() { const selectedOptionEl = document.querySelector('.poll-option.selected'); if (!selectedOptionEl) { alert('Please select an option to vote.'); return; } const selectedOption = selectedOptionEl.dataset.option; database.ref(`users/${currentUser.id}/votedPolls/${activePoll.id}`).set(true); database.ref(`polls/${activePoll.id}/options/${selectedOption}`).transaction(currentCount => (currentCount || 0) + 1); closePollPopup(); alert('Thanks for voting!'); }
        function closePollPopup() { document.getElementById('poll-popup').style.display = 'none'; }
        
        function filterContent() { currentFilters.searchTerm = document.getElementById('search-input').value.toLowerCase(); let filteredList = allContent; if (currentFilters.searchTerm) { filteredList = filteredList.filter(item => item.title.toLowerCase().includes(currentFilters.searchTerm)); } updateCategories(filteredList); }
        
        function updateCategories(contentToDisplay) {
            const sliders = { Hollywood: document.getElementById('hollywood-slider'), Bollywood: document.getElementById('bollywood-slider'), 'South Indian': document.getElementById('south-slider'), 'Tollywood (Bengali)': document.getElementById('tollywood-slider'), 'Punjabi Movie': document.getElementById('punjabi-slider'), 'Korean Movie': document.getElementById('korean-slider'), 'Chinese Movie': document.getElementById('chinese-slider'), 'Malayalam Movie': document.getElementById('malayalam-slider'), 'Marathi Movie': document.getElementById('marathi-slider'), '18+ Movie': document.getElementById('adult-slider') };
            Object.values(sliders).forEach(s => s.innerHTML = '');
            contentToDisplay.forEach(item => { if (sliders[item.category]) { sliders[item.category].appendChild(createContentCard(item)); } });
            document.querySelectorAll('#categories-container .category-section').forEach(section => { const slider = section.querySelector('.content-slider'); section.style.display = slider.children.length > 0 ? 'block' : 'none'; });
        }

        function updateSlider() { const slider = document.getElementById('slider'); const indicators = document.getElementById('slider-indicators'); slider.innerHTML = ''; indicators.innerHTML = ''; const recentItems = allContent.slice(0, 5); recentItems.forEach((item, index) => { const slide = document.createElement('div'); slide.className = 'slide'; slide.innerHTML = `<img src="${item.backdrop}" alt="${item.title}"><div class="slide-overlay"><div class="slide-title">${item.title}</div><div class="slide-meta"><span>${item.year}</span><span class="slide-rating"><i class="fas fa-star"></i> ${item.rating}</span><span>${item.type === 'webseries' ? 'Series' : 'Movie'}</span></div></div>`; slide.onclick = () => handleContentClick(item.id); slider.appendChild(slide); const indicator = document.createElement('div'); indicator.className = `indicator ${index === 0 ? 'active' : ''}`; indicator.onclick = () => goToSlide(index); indicators.appendChild(indicator); }); startSlider(); }
        function updateTrendingSection() { const slider = document.getElementById('trending-slider'); slider.innerHTML = ''; const trendingItems = allContent.slice(0, 10); trendingItems.forEach((item, index) => { slider.appendChild(createContentCard(item)); }); const trendingSection = slider.closest('.category-section'); if (trendingSection) { trendingSection.style.display = trendingItems.length > 0 ? 'block' : 'none'; } }
        function goToSlide(index) { currentSlide = index; document.getElementById('slider').style.transform = `translateX(-${currentSlide * 100}%)`; document.querySelectorAll('.indicator').forEach((ind, i) => ind.classList.toggle('active', i === currentSlide)); }
        function startSlider() { if (sliderInterval) clearInterval(sliderInterval); sliderInterval = setInterval(() => { const slides = document.querySelectorAll('#slider .slide'); if (slides.length === 0) return; currentSlide = (currentSlide + 1) % slides.length; goToSlide(currentSlide); }, 5000); }
        
        function createContentCard(item) { const card = document.createElement('div'); card.className = 'content-card'; const languageBadge = item.language ? `<span class="content-language-badge">${item.language}</span>` : ''; card.innerHTML = `${languageBadge}<img src="${item.poster}" alt="${item.title}"><div class="content-title">${item.title}</div>`; card.onclick = () => handleContentClick(item.id); return card; }
        
        async function showDetail(item) {
            currentContent = item;
            const isInWatchlist = (await database.ref(`users/${currentUser.id}/watchlist/${item.id}`).once('value')).exists();
            const mainActionBtn = item.type === 'movie' ? `<button class="btn" onclick="playContent()"><i class="fas fa-play"></i> Play</button>` : `<button class="btn" onclick="openEpisodeModal()"><i class="fas fa-list-ul"></i> Episodes</button>`;
            const qualityHTML = item.quality ? `<span><i class="fas fa-certificate"></i> ${item.quality}</span>` : '';
            const size1080pHTML = item.size1080p ? `<span><i class="fas fa-hdd"></i> 1080p: ${item.size1080p}</span>` : '';
            const size720pHTML = item.size720p ? `<span><i class="fas fa-hdd"></i> 720p: ${item.size720p}</span>` : '';
            document.getElementById('detail-page').innerHTML = `<div class="detail-backdrop"><img src="${item.backdrop}"></div><div class="detail-content"><div class="detail-poster"><img src="${item.poster}"></div><div class="detail-info"><h1 class="detail-title">${item.title}</h1><div class="detail-meta"><span><i class="fas fa-calendar"></i> ${item.year}</span><span><i class="fas fa-star"></i> ${item.rating}</span><span><i class="fas fa-language"></i> ${item.language}</span><span><i class="fas fa-crown"></i> ${item.access}</span>${qualityHTML}${size1080pHTML}${size720pHTML}</div><div class="detail-actions">${mainActionBtn}<button class="btn btn-secondary" id="watchlist-btn" onclick="toggleWatchlist()"><i class="fas ${isInWatchlist ? 'fa-check' : 'fa-plus'}"></i> ${isInWatchlist ? 'Added' : 'Watchlist'}</button></div></div></div><div style="padding: 0 15px;"><div class="detail-storyline">${item.storyline}</div><div class="detail-cast"><h3>Cast</h3><div class="cast-list" id="detail-cast-list"></div></div><div class="similar-section"><h3>More Like This</h3><div class="content-slider" id="similar-slider"></div></div><div class="comments-section"><h3>Comments</h3><div class="comment-form"><input type="text" class="comment-input" id="comment-input" placeholder="Add a comment..."><button class="comment-btn" onclick="addComment()">Post</button></div><div class="comments-list" id="comments-list"></div></div></div>`;
            if (item.cast?.length > 0) { const castList = document.getElementById('detail-cast-list'); item.cast.forEach(actor => { const castItem = document.createElement('div'); castItem.className = 'cast-item'; castItem.innerHTML = `<img src="${actor.photo}" alt="${actor.name}" onclick="showCastFullView('${actor.photo}', '${actor.name}')"><p>${actor.name}</p>`; castList.appendChild(castItem); }); } if (item.type === 'webseries' && item.episodes?.length > 0) { populateEpisodeModal(item.id, item.title, item.episodes); } const similarSlider = document.getElementById('similar-slider'); allContent.filter(c => c.id !== item.id && c.category === item.category).slice(0, 5).forEach(c => similarSlider.appendChild(createContentCard(c))); loadComments(item.id); navigateTo('detail-page'); playStorylineAudio(item.storyline);
        }
        function showCategoryPage(categoryName) { const page = document.getElementById('category-page'); const categoryContent = allContent.filter(item => item.category === categoryName); let gridHTML = ''; categoryContent.forEach(item => { const languageBadge = item.language ? `<span class="content-language-badge">${item.language}</span>` : ''; gridHTML += `<div class="content-card" onclick="handleContentClick('${item.id}')">${languageBadge}<img src="${item.poster}" alt="${item.title}"><div class="content-title">${item.title}</div></div>`; }); page.innerHTML = `<div class="page-header">${categoryName}</div><div class="content-grid">${gridHTML}</div>`; navigateTo('category-page'); }
        function populateEpisodeModal(contentId, title, episodes) { const listContainer = document.getElementById('episode-modal-list'); document.getElementById('episode-modal-title').textContent = title + ' - Episodes'; listContainer.innerHTML = ''; const seasons = episodes.reduce((acc, ep) => { const seasonNum = ep.session || '1'; if (!acc[seasonNum]) acc[seasonNum] = []; acc[seasonNum].push(ep); return acc; }, {}); for (const seasonNum in seasons) { const seasonHeader = document.createElement('h3'); seasonHeader.className = 'episode-season-header'; seasonHeader.textContent = `Season ${seasonNum}`; listContainer.appendChild(seasonHeader); seasons[seasonNum].forEach(ep => { const epItem = document.createElement('div'); epItem.className = 'episode-item'; epItem.innerHTML = `<div class="episode-thumbnail"><img src="${currentContent.poster}"></div><div class="episode-info"><div class="episode-title">Episode ${ep.number}</div></div><button class="episode-play" onclick="playEpisode('${ep.link}', '${contentId}', '${ep.number}')"><i class="fas fa-play"></i></button>`; listContainer.appendChild(epItem); }); } }
        function openEpisodeModal() { document.getElementById('episode-modal').style.display = 'flex'; }
        function closeEpisodeModal() { document.getElementById('episode-modal').style.display = 'none'; }
        
        function openUpcomingModal(item) { if (countdownInterval) clearInterval(countdownInterval); const modal = document.getElementById('upcoming-modal'); document.getElementById('upcoming-modal-poster').src = item.poster; document.getElementById('upcoming-modal-title').textContent = item.title; const releaseDate = new Date(item.releaseDate); document.getElementById('upcoming-modal-release-date').textContent = `Releasing on: ${releaseDate.toDateString()}`; const updateCountdown = () => { const now = new Date().getTime(); const distance = releaseDate.getTime() - now; if (distance < 0) { clearInterval(countdownInterval); document.getElementById('upcoming-modal-countdown').innerHTML = `<p style="font-size:1.2em; color:var(--primary-color);">Released!</p>`; return; } const days = Math.floor(distance / (1000 * 60 * 60 * 24)); const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)); const seconds = Math.floor((distance % (1000 * 60)) / 1000); document.getElementById('countdown-days').textContent = String(days).padStart(2, '0'); document.getElementById('countdown-hours').textContent = String(hours).padStart(2, '0'); document.getElementById('countdown-mins').textContent = String(minutes).padStart(2, '0'); document.getElementById('countdown-secs').textContent = String(seconds).padStart(2, '0'); }; updateCountdown(); countdownInterval = setInterval(updateCountdown, 1000); modal.style.display = 'flex'; }
        function closeUpcomingModal() { document.getElementById('upcoming-modal').style.display = 'none'; if (countdownInterval) clearInterval(countdownInterval); }

        function loadComments(contentId) {
            const commentsList = document.getElementById('comments-list');
            const commentsRef = database.ref(`comments/${contentId}`);
            commentsRef.on('value', snapshot => {
                commentsList.innerHTML = '';
                if (!snapshot.exists()) { commentsList.innerHTML = '<p style="color: var(--secondary-text-color); text-align: center;">No comments yet.</p>'; return; }
                snapshot.forEach(childSnapshot => {
                    const comment = childSnapshot.val();
                    let replyHTML = '';
                    if (comment.reply && comment.reply.text) { replyHTML = `<div class="comment-reply"><div class="comment-reply-header"><i class="fas fa-crown"></i> Admin Reply</div><p class="comment-reply-text">${comment.reply.text}</p></div>`; }
                    const item = document.createElement('div');
                    item.className = 'comment-item';
                    item.innerHTML = `<div class="comment-header"><span class="comment-user">${comment.user}</span></div><p class="comment-text">${comment.text}</p>${replyHTML}`;
                    commentsList.prepend(item);
                });
            });
        }
        
        async function addComment() {
            if (!currentContent || !currentUser) return;
            const textInput = document.getElementById('comment-input');
            const text = textInput.value.trim();
            if (!text) return;
            const commentsRef = database.ref(`comments/${currentContent.id}`);
            const userCommentSnapshot = await commentsRef.orderByChild('userId').equalTo(currentUser.id).once('value');
            if (userCommentSnapshot.exists()) { alert("You have already commented on this content. Only one comment per user is allowed."); return; }
            database.ref(`comments/${currentContent.id}`).push({ user: currentUser.name, userId: currentUser.id, text: text, timestamp: Date.now() });
            textInput.value = '';
        }
        
        async function toggleWatchlist() { if (!currentUser || !currentContent) return; const watchlistRef = database.ref(`users/${currentUser.id}/watchlist/${currentContent.id}`); const snapshot = await watchlistRef.once('value'); const btn = document.getElementById('watchlist-btn'); if (snapshot.exists()) { watchlistRef.remove(); btn.innerHTML = `<i class="fas fa-plus"></i> Watchlist`; } else { watchlistRef.set(true); btn.innerHTML = `<i class="fas fa-check"></i> Added`; } }
        async function loadWatchlist() { const grid = document.getElementById('watchlist-grid'); const placeholder = document.getElementById('watchlist-placeholder'); grid.innerHTML = ''; const watchlistRef = database.ref(`users/${currentUser.id}/watchlist`); const snapshot = await watchlistRef.once('value'); if (!snapshot.exists()) { placeholder.style.display = 'block'; return; } placeholder.style.display = 'none'; const watchlistIds = Object.keys(snapshot.val()); const watchlistContent = allContent.filter(item => watchlistIds.includes(item.id)); watchlistContent.forEach(item => grid.appendChild(createContentCard(item))); }
        function incrementViewCount(contentId) { database.ref(`views/${contentId}/count`).transaction(currentCount => (currentCount || 0) + 1); }
        
        function logWatchHistory(contentId) {
            if (!currentUser || !contentId) return;
            const historyRef = database.ref(`users/${currentUser.id}/history/${contentId}`);
            historyRef.set({
                watchedAt: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function handleEditProfile() { if (!currentUser) return; const newName = prompt("Enter your new name:", currentUser.name); if (newName && newName.trim().length >= 3) { const trimmedName = newName.trim(); database.ref('users/' + currentUser.id).update({ name: trimmedName }).then(() => { currentUser.name = trimmedName; localStorage.setItem('nh_box_user', JSON.stringify(currentUser)); setupProfilePage(); alert("Profile name updated successfully!"); }).catch(error => alert("Failed to update profile name.")); } else if (newName !== null) { alert("Name must be at least 3 characters long."); } }
        async function showWatchHistory() { const page = document.getElementById('history-page'); page.innerHTML = `<div class="page-header">Watch History</div><div class="content-grid" id="history-grid"></div><div id="history-placeholder" class="placeholder-text" style="display: none;">You haven't watched anything yet.</div>`; navigateTo('history-page'); const grid = document.getElementById('history-grid'); const placeholder = document.getElementById('history-placeholder'); if (!currentUser) { placeholder.style.display = 'block'; return; } const historyRef = database.ref(`users/${currentUser.id}/history`).orderByChild('watchedAt'); const snapshot = await historyRef.once('value'); if (!snapshot.exists()) { placeholder.style.display = 'block'; return; } placeholder.style.display = 'none'; const historyData = snapshot.val(); const sortedHistoryIds = Object.keys(historyData).sort((a, b) => historyData[b].watchedAt - historyData[a].watchedAt); const historyContent = sortedHistoryIds.map(id => allContent.find(item => item.id === id)).filter(item => item); historyContent.forEach(item => grid.appendChild(createContentCard(item))); }
        
        let adCountdownInterval = null;
        const AD_URL = 'https://www.revenuecpmgate.com/m5m1bff6?key=0558c7ff0612e578535a79ed2537fb5f';
        const AD_DURATION = 20;
        const SKIP_TIME = 17;

        function showAd(callback) {
            if (isUserSubscribed()) {
                callback();
                return;
            }
            onAdCompleteCallback = callback;
            const adOverlay = document.getElementById('ad-overlay');
            const adIframe = document.getElementById('ad-iframe');
            const countdownText = document.getElementById('ad-countdown-text');
            const skipBtn = document.getElementById('ad-skip-btn');
            adIframe.src = AD_URL;
            skipBtn.style.display = 'none';
            skipBtn.onclick = () => closeAdAndPlay();
            if (adCountdownInterval) clearInterval(adCountdownInterval);
            let countdown = AD_DURATION;
            countdownText.textContent = `Your content will start in ${countdown} seconds...`;
            adOverlay.style.display = 'flex';
            adCountdownInterval = setInterval(() => {
                countdown--;
                countdownText.textContent = `Your content will start in ${countdown} seconds...`;
                if ((AD_DURATION - countdown) >= SKIP_TIME) { skipBtn.style.display = 'block'; }
                if (countdown <= 0) { closeAdAndPlay(); }
            }, 1000);
        }

        function closeAdAndPlay() {
            if (adCountdownInterval) { clearInterval(adCountdownInterval); adCountdownInterval = null; }
            const adOverlay = document.getElementById('ad-overlay');
            const adIframe = document.getElementById('ad-iframe');
            adOverlay.style.display = 'none';
            adIframe.src = 'about:blank';
            if (typeof onAdCompleteCallback === 'function') { onAdCompleteCallback(); }
            onAdCompleteCallback = null;
        }

        function playContent() { stopStorylineAudio(); if (!currentContent) return; incrementViewCount(currentContent.id); logWatchHistory(currentContent.id); showAd(() => { playVideo(currentContent.link); }); }
        
        function playEpisode(link, contentId, episodeNumber) {
            stopStorylineAudio();
            incrementViewCount(contentId);
            logWatchHistory(contentId);
            const seriesPlayer = document.getElementById('series-player-modal');
            const seriesIframe = document.getElementById('series-iframe');
            const episodeListContainer = document.getElementById('series-episode-list');
            
            seriesIframe.src = ''; 
            episodeListContainer.innerHTML = '';
            currentContent.episodes.forEach(ep => {
                const epItem = document.createElement('div');
                epItem.className = 'episode-item';
                if (ep.number == episodeNumber) {
                    epItem.classList.add('playing');
                }
                epItem.innerHTML = `<div class="episode-thumbnail"><img src="${currentContent.poster}"></div><div class="episode-info"><div class="episode-title">Episode ${ep.number}</div></div><button class="episode-play"><i class="fas fa-play"></i></button>`;
                epItem.onclick = () => playEpisode(ep.link, contentId, ep.number);
                episodeListContainer.appendChild(epItem);
            });
            seriesPlayer.style.display = 'flex';
            setTimeout(() => seriesPlayer.classList.add('active'), 10);
            closeEpisodeModal();
            showAd(() => {
                seriesIframe.src = 'https://video-player-nhbox.vercel.app/?url=' + encodeURIComponent(link);
            });
        }

        function playVideo(link) {
            const videoPlayer = document.getElementById('video-player');
            const videoIframe = document.getElementById('video-iframe');
            videoIframe.src = 'https://video-player-nhbox.vercel.app/?url=' + encodeURIComponent(link);
            videoPlayer.style.display = 'block';
        }

        function closeVideoPlayer() { 
            const videoPlayer = document.getElementById('video-player');
            const videoIframe = document.getElementById('video-iframe');
            videoIframe.src = 'about:blank';
            videoPlayer.style.display = 'none'; 
        }

        function closeSeriesPlayer() { 
            const seriesPlayer = document.getElementById('series-player-modal'); 
            const seriesIframe = document.getElementById('series-iframe');
            seriesPlayer.classList.remove('active'); 
            setTimeout(() => { 
                seriesPlayer.style.display = 'none'; 
                seriesIframe.src = 'about:blank';
            }, 400); 
        }
        
        function showCastFullView(photo, name) { document.getElementById('cast-full-image').src = photo; document.getElementById('cast-full-name').textContent = name; document.getElementById('cast-full-view').style.display = 'flex'; }
        function closeCastFullView() { document.getElementById('cast-full-view').style.display = 'none'; }
        
        function shareApplication() {
            const shareData = {
                title: 'NH BOX - Stream Movies & Web Series',
                text: 'Check out NH BOX! Stream the latest movies and web series. Install the app from the website.',
                url: window.location.href
            };

            if (navigator.share) {
                navigator.share(shareData)
                    .then(() => console.log('Successful share'))
                    .catch((error) => console.log('Error sharing:', error));
            } else {
                navigator.clipboard.writeText(shareData.url).then(() => {
                    alert('App link copied to clipboard! You can now paste it to share with friends on WhatsApp, Telegram, etc.');
                }).catch(err => {
                    console.error('Could not copy text: ', err);
                    alert('Sharing is not supported on this browser. Please copy the URL from the address bar manually.');
                });
            }
        }

        function loadLiveTvChannels() {
            const grid = document.getElementById('livetv-grid');
            const placeholder = document.getElementById('livetv-placeholder');
            database.ref('live_tv').on('value', snapshot => {
                grid.innerHTML = '';
                if (!snapshot.exists()) { placeholder.style.display = 'block'; return; }
                placeholder.style.display = 'none';
                snapshot.forEach(child => {
                    const channel = { id: child.key, ...child.val() };
                    const card = document.createElement('div');
                    card.className = 'livetv-card';
                    card.innerHTML = `<img src="${channel.logo}" alt="${channel.name} Logo"><p class="livetv-card-name">${channel.name}</p>`;
                    card.onclick = () => handleLiveTvClick(channel);
                    grid.appendChild(card);
                });
            });
        }
        
        function handleLiveTvClick(channel) {
            if (channel.maintenance === true) {
                showMaintenancePopup();
            } else {
                showAd(() => {
                    window.open(channel.link, '_blank');
                });
            }
        }
        
        function loadSubscriptionPlans() {
            database.ref('subscriptions/plans').on('value', snapshot => {
                if (snapshot.exists()) {
                    subscriptionPlans = snapshot.val();
                }
            });
        }

        function showSubscriptionPage() {
            const container = document.getElementById('subscription-plans-container');
            container.innerHTML = '';
            if (Object.keys(subscriptionPlans).length === 0) {
                container.innerHTML = `<p class="placeholder-text">Subscription plans are not available at the moment.</p>`;
            } else {
                for (const planName in subscriptionPlans) {
                    const plan = subscriptionPlans[planName];
                    let featuresHTML = '';
                    plan.conveniences.forEach(feature => {
                        featuresHTML += `<li><i class="fas fa-check-circle"></i> ${feature}</li>`;
                    });

                    const card = document.createElement('div');
                    card.className = `plan-card ${plan.name}`;
                    card.innerHTML = `
                        <h3 class="plan-name ${plan.name}">${plan.name}</h3>
                        <div class="plan-price">${plan.rate} <span>/ ${plan.validity} days</span></div>
                        <ul class="plan-features">${featuresHTML}</ul>
                        <button class="btn" onclick="openCheckoutModal('${plan.name}')">Checkout</button>
                    `;
                    container.appendChild(card);
                }
            }
            navigateTo('subscription-page');
        }

        function openCheckoutModal(planName) {
            const plan = subscriptionPlans[planName];
            if (!plan) return;
            document.getElementById('checkout-modal-title').textContent = `Purchase ${plan.name} Plan`;
            document.getElementById('checkout-qr-code').src = plan.qrUrl;
            document.getElementById('checkout-transaction-id').value = '';
            document.getElementById('checkout-utr-id').value = '';
            document.getElementById('checkout-send-btn').onclick = () => submitSubscriptionRequest(planName);
            document.getElementById('checkout-modal').style.display = 'flex';
        }

        function closeCheckoutModal() {
            document.getElementById('checkout-modal').style.display = 'none';
        }

        async function submitSubscriptionRequest(planName) {
            const transactionIdInput = document.getElementById('checkout-transaction-id');
            const utrIdInput = document.getElementById('checkout-utr-id');
            
            const transactionId = transactionIdInput.value.trim();
            const utrId = utrIdInput.value.trim();

            if (!transactionId) {
                alert('Please enter the Transaction ID.');
                return;
            }

            const sendBtn = document.getElementById('checkout-send-btn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

            try {
                const requestData = {
                    userId: currentUser.id,
                    userName: currentUser.name,
                    planName: planName,
                    transactionId: transactionId,
                    utrId: utrId,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                await database.ref('subscriptions/requests').push(requestData);
                
                closeCheckoutModal();
                alert('Your request has been submitted successfully! Please wait for admin approval. This may take some time.');
                
                transactionIdInput.value = '';
                utrIdInput.value = '';

            } catch (error) {
                console.error("Error submitting request:", error);
                alert('An error occurred while submitting your request. Please try again.');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send for Review';
            }
        }
        
        // --- START: COUPON FUNCTIONS ---
        function openCouponModal() {
            document.getElementById('coupon-modal').style.display = 'flex';
        }

        function closeCouponModal() {
            document.getElementById('coupon-modal').style.display = 'none';
        }

        async function redeemCoupon() {
            const codeInput = document.getElementById('coupon-code-input');
            const code = codeInput.value.trim().toUpperCase();

            if (code.length !== 7) {
                alert('Please enter a valid 7-digit coupon code.');
                return;
            }

            const couponRef = database.ref('coupons/' + code);
            const snapshot = await couponRef.once('value');

            if (!snapshot.exists()) {
                alert('Invalid coupon code. Please check and try again.');
                return;
            }

            const coupon = snapshot.val();
            const redeemedCount = coupon.redeemedBy ? Object.keys(coupon.redeemedBy).length : 0;

            if (coupon.redeemedBy && coupon.redeemedBy[currentUser.id]) {
                alert('You have already used this coupon code.');
                return;
            }

            if (redeemedCount >= coupon.limit) {
                alert('This coupon code has reached its maximum usage limit.');
                return;
            }
            
            const planData = subscriptionPlans[coupon.category];
            if (!planData) {
                alert('The plan associated with this coupon is not available. Please contact support.');
                return;
            }

            try {
                const validityDays = planData.validity || 30;
                const expiresAt = Date.now() + (validityDays * 24 * 60 * 60 * 1000);

                const subscriptionInfo = {
                    planName: coupon.category,
                    activatedAt: firebase.database.ServerValue.TIMESTAMP,
                    expiresAt: expiresAt
                };

                // Update user's subscription and coupon's redeemed list
                await database.ref(`users/${currentUser.id}/subscription`).set(subscriptionInfo);
                await database.ref(`coupons/${code}/redeemedBy/${currentUser.id}`).set(currentUser.name);
                
                // Update local currentUser object
                currentUser.subscription = subscriptionInfo;
                localStorage.setItem('nh_box_user', JSON.stringify(currentUser));

                alert(`Success! Your ${coupon.category} plan has been activated.`);
                closeCouponModal();
                setupProfilePage(); // Refresh profile UI
                codeInput.value = '';

            } catch (error) {
                console.error("Error redeeming coupon:", error);
                alert('An error occurred during redemption. Please try again.');
            }
        }
        // --- END: COUPON FUNCTIONS ---

        // --- START: NEW UI FUNCTIONS ---
        function populateMoviesPage() {
            const page = document.getElementById('movies-page');
            const moviesContent = allContent.filter(item => item.type === 'movie');
            let gridHTML = '';
            if (moviesContent.length > 0) {
                moviesContent.forEach(item => {
                    gridHTML += createContentCard(item).outerHTML;
                });
            } else {
                gridHTML = '<p class="placeholder-text">No movies available at the moment.</p>';
            }
            page.innerHTML = `<div class="page-header">Movies</div><div class="content-grid">${gridHTML}</div>`;
        }
        
        function populateSeriesPage() {
            const page = document.getElementById('series-page');
            const seriesContent = allContent.filter(item => item.type === 'webseries');
            let gridHTML = '';
             if (seriesContent.length > 0) {
                seriesContent.forEach(item => {
                    gridHTML += createContentCard(item).outerHTML;
                });
            } else {
                 gridHTML = '<p class="placeholder-text">No series available at the moment.</p>';
            }
            page.innerHTML = `<div class="page-header">Series</div><div class="content-grid">${gridHTML}</div>`;
        }
        // --- END: NEW UI FUNCTIONS ---

    </script>
</body>
</html>
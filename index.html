<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime07x - Pro Streaming Fixed</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#d6006e"/>

    <!-- Firebase & HLS.js CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #d6006e; --bg: #0b0c15; --card: #151725; --text: #ffffff; --border: #23263a; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        body { background-color: var(--bg); color: var(--text); overflow: hidden; -webkit-tap-highlight-color: transparent; }

        #page-container { max-width: 480px; margin: 0 auto; height: 100vh; position: relative; display: flex; flex-direction: column; }

        /* --- SELECTIVE ANIMATION LOGIC --- */
        @property --angle { syntax: '<angle>'; initial-value: 0deg; inherits: false; }
        @keyframes rotate { to { --angle: 360deg; } }
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; filter: brightness(1.3); } 100% { opacity: 0.7; } }
        @keyframes rgbShift { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }

        /* Rounded Border Fix */
        .anim-active .search-box, 
        .anim-active #appearance-btn, 
        .anim-active #anim-mode-btn, 
        .anim-active .content-card,
        .anim-active .detail-poster-img { 
            border: 2px solid transparent !important; 
        }

        /* Style 1: Updated for Round Shape Rotation */
        body.anim-1 .search-box, 
        body.anim-1 #appearance-btn, 
        body.anim-1 #anim-mode-btn, 
        body.anim-1 .content-card,
        body.anim-1 .detail-poster-img {
            background: linear-gradient(var(--card), var(--card)) padding-box, 
                        linear-gradient(var(--angle), #00ccff, #fdfd1e, #f000ff, #7200ff, #00ccff) border-box !important;
            animation: rotate 3s linear infinite;
        }
        /* Specific Fix for Search Box Background */
        body.anim-1 .search-section .search-box {
            background: linear-gradient(var(--bg), var(--bg)) padding-box, 
                        linear-gradient(var(--angle), #00ccff, #fdfd1e, #f000ff, #7200ff, #00ccff) border-box !important;
        }

        /* Style 2: Pulsing Glow (Already Round) */
        body.anim-2 .search-box, 
        body.anim-2 #appearance-btn, 
        body.anim-2 #anim-mode-btn, 
        body.anim-2 .content-card,
        body.anim-2 .detail-poster-img {
            border-color: var(--primary) !important;
            animation: pulse 2s ease-in-out infinite !important;
            box-shadow: 0 0 10px rgba(214, 0, 110, 0.4);
        }

        /* Style 3: RGB Wave (Already Round) */
        body.anim-3 .search-box, 
        body.anim-3 #appearance-btn, 
        body.anim-3 #anim-mode-btn, 
        body.anim-3 .content-card,
        body.anim-3 .detail-poster-img {
            border-color: #00d2ff !important;
            animation: rgbShift 4s linear infinite !important;
        }
        /* ---------------------------------- */

        .logo-section { background: var(--bg); padding: 15px 0 5px 0; display: flex; justify-content: center; width: 100%; }
        .logo-section img { height: 45px; width: auto; object-fit: contain; }

        .search-section { background: var(--bg); padding: 10px 15px; display: flex; justify-content: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); backdrop-filter: blur(12px); }
        .search-box { background: rgba(255,255,255,0.05); padding: 10px 15px; border-radius: 25px; border: 1px solid var(--border); width: 100%; display: flex; align-items: center; }
        .search-box input { background: none; border: none; color: #fff; outline: none; font-size: 14px; width: 100%; text-align: center; }

        .page { flex: 1; overflow-y: auto; display: none; padding-bottom: 90px; }
        .page.active { display: block; }

        .slider-container { width: 100%; height: 230px; overflow: hidden; position: relative; border-radius: 0 0 20px 20px; background: #000; }
        .slider { display: flex; transition: 0.6s ease; height: 100%; }
        .slide { min-width: 100%; height: 100%; position: relative; cursor: pointer; }
        .slide img { width: 100%; height: 100%; object-fit: cover; }
        
        .category-header { display: flex; justify-content: space-between; align-items: center; padding-right: 15px; margin-top: 20px; }
        .category-title { font-size: 18px; font-weight: 700; padding-left: 15px; border-left: 4px solid var(--primary); }
        .view-all { color: var(--primary); font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer; }

        .content-slider { display: flex; overflow-x: auto; padding: 10px 15px; gap: 12px; scrollbar-width: none; }
        .content-slider::-webkit-scrollbar { display: none; }
        
        .content-card { flex: 0 0 120px; border-radius: 12px; overflow: hidden; background: var(--card); aspect-ratio: 2/3; position: relative; cursor: pointer; border: 1px solid var(--border); }
        .content-card img { width: 100%; height: 100%; object-fit: cover; }
        .card-title { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7); padding: 5px; font-size: 10px; text-align: center; }

        #player-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: none; }
        .video-wrapper { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: contain; }
        
        .player-ui { position: absolute; inset: 0; background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, transparent 50%, rgba(0,0,0,0.8) 100%); display: flex; flex-direction: column; justify-content: space-between; padding: 25px; z-index: 10; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); opacity: 1; }
        .player-ui.hidden { opacity: 0; pointer-events: none; }

        .p-btn { background: none; border: none; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; }
        .p-btn i { font-size: 22px; }
        .p-btn:active { transform: scale(0.8); color: var(--primary); text-shadow: 0 0 15px var(--primary); }

        .p-top { display: flex; align-items: center; gap: 15px; }
        #video-title { font-weight: 700; font-size: 16px; color: #fff; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .p-mid { display: none; }

        .p-bottom-area { width: 100%; display: flex; flex-direction: column; gap: 15px; }

        /* --- UPDATED SEEKBAR WITH TIME --- */
        .p-progress-box { width: 100%; height: 30px; display: flex; align-items: center; cursor: pointer; position: relative; gap: 10px; }
        .p-bar-bg { flex: 1; height: 4px; background: rgba(255,255,255,0.2); border-radius: 10px; position: relative; transition: height 0.2s; }
        .p-progress-box:hover .p-bar-bg { height: 6px; }
        #p-fill { height: 100%; background: var(--primary); width: 0%; border-radius: 10px; position: relative; transition: width 0.1s linear; box-shadow: 0 0 10px var(--primary); }
        #p-fill::after { content: ''; position: absolute; right: -7px; top: 50%; transform: translateY(-50%) scale(0); width: 14px; height: 14px; background: #fff; border-radius: 50%; border: 2px solid var(--primary); box-shadow: 0 0 8px var(--primary); transition: 0.2s; }
        .p-progress-box:hover #p-fill::after { transform: translateY(-50%) scale(1); }
        .seekbar-time { font-family: monospace; font-size: 12px; font-weight: bold; color: #fff; min-width: 40px; }

        /* --- EPISODE DRAWER CSS --- */
        #p-ep-drawer {
            position: absolute; right: -280px; top: 0; bottom: 0; width: 250px;
            background: rgba(11, 12, 21, 0.98); border-left: 1px solid var(--border);
            z-index: 101; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; padding: 20px 0;
        }
        #p-ep-drawer.open { right: 0; }
        .drawer-header { padding: 0 20px 15px; border-bottom: 1px solid var(--border); font-weight: bold; color: var(--primary); display: flex; justify-content: space-between; align-items: center; font-size: 16px; }
        .drawer-list { flex: 1; overflow-y: auto; padding: 15px; scrollbar-width: none; }
        .drawer-item { 
            background: var(--card); padding: 12px; border-radius: 10px; margin-bottom: 10px; 
            display: flex; align-items: center; gap: 12px; cursor: pointer; border: 1px solid transparent;
            font-size: 13px; color: #fff; transition: 0.2s;
        }
        .drawer-item:active { transform: scale(0.95); }
        .drawer-item i { color: var(--primary); font-size: 14px; }

        .p-controls-bar { display: flex; justify-content: space-between; align-items: center; }
        .p-left, .p-right { display: flex; align-items: center; gap: 15px; }

        .p-vol-box { display: flex; align-items: center; gap: 8px; }
        #vol-slider { width: 60px; height: 4px; accent-color: var(--primary); cursor: pointer; display: none; transition: 0.3s; }
        .p-vol-box:hover #vol-slider { display: block; }

        /* Icon Hide Logic */
        .hide-in-portrait { display: none !important; }
        .video-wrapper:fullscreen .hide-in-portrait,
        .video-wrapper:-webkit-full-screen .hide-in-portrait { display: flex !important; }
        
        /* Vertical Speed Menu */
        #p-speed-menu {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 120px;
            background: rgba(0,0,0,0.7);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 25px;
            z-index: 100;
        }
        .speed-item { color: #fff; font-size: 15px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .speed-item.active { color: #2ecc71; }

        #speed-overlay { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: #fff; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: bold; display: none; z-index: 100; pointer-events: none; border: 1px solid var(--primary); }

        .p-menu { 
            position: absolute; 
            bottom: 100px; 
            right: 25px; 
            background: #0f101a; 
            border-radius: 15px; 
            display: none; 
            flex-direction: column; 
            min-width: 170px; 
            max-height: 250px;
            overflow-y: auto; 
            z-index: 100; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); 
            animation: slideUp 0.3s ease; 
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .p-menu-header { background: var(--primary); color: #fff; padding: 12px; text-align: center; font-weight: 700; font-size: 14px; position: sticky; top: 0; z-index: 1; }
        .p-menu-item { padding: 14px 20px; font-size: 14px; border-bottom: 1px solid var(--border); cursor: pointer; color: #fff; transition: 0.2s; }
        .p-menu-item:hover { background: rgba(255,255,255,0.05); }
        .p-menu-item.active { color: var(--primary); font-weight: bold; background: rgba(214, 0, 110, 0.1); }

        /* Custom Alert Modals */
        #appearance-modal, #confirm-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .theme-container, .confirm-box { background: #12131d; width: 90%; max-width: 300px; border-radius: 24px; padding: 25px; border: 1px solid #23263a; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.5); }
        
        .confirm-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #fff; }
        .confirm-msg { font-size: 14px; color: #aaa; margin-bottom: 25px; }
        .confirm-btns { display: flex; gap: 10px; }
        .confirm-btns button { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-cancel { background: #23263a; color: #fff; }
        .btn-confirm { background: var(--primary); color: #fff; }
        .btn-confirm:active { transform: scale(0.95); }

        .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .theme-card { background: #1a1c29; border-radius: 15px; padding: 15px; text-align: center; cursor: pointer; border: 2px solid transparent; }
        .theme-card.active { border-color: var(--primary); }
        
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: #0f101a; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid var(--border); z-index: 1000; border-radius: 20px 20px 0 0; }
        .nav-item { color: #5c5e70; text-align: center; font-size: 10px; flex: 1; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 4px; }
        
        .grid-view { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; }
        .ep-list-item { background: var(--card); padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }

        .detail-backdrop { width: 100%; height: 350px; position: relative; }
        .detail-backdrop img { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.6); }
        .backdrop-overlay { position: absolute; inset: 0; background: linear-gradient(0deg, var(--bg) 10%, transparent 100%); }
        .detail-content { position: relative; margin-top: -150px; padding: 0 20px; }
        .detail-main { display: flex; gap: 20px; align-items: flex-end; }
        .detail-poster-img { width: 120px; aspect-ratio: 2/3; border-radius: 15px; object-fit: cover; border: 2px solid var(--border); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .detail-info { flex: 1; padding-bottom: 10px; }
        .detail-info h2 { font-size: 24px; font-weight: 800; margin-bottom: 10px; }
        .meta-badges { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .badge { background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: bold; color: #ccc; display: flex; align-items: center; gap: 4px; }
        .badge i { color: #ffc107; font-size: 10px; }
        .detail-actions { display: flex; gap: 12px; margin-top: 20px; }
        .btn-episodes { background: #7c4dff; color: #fff; flex: 1; padding: 14px; border-radius: 12px; border: none; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; text-transform: uppercase; cursor: pointer; }
        .btn-plus { background: #23263a; color: #fff; width: 55px; height: 55px; border-radius: 12px; border: none; font-size: 20px; cursor: pointer; }
        .desc-box { background: rgba(255,255,255,0.03); border-radius: 15px; padding: 15px; margin-top: 25px; border-left: 4px solid #7c4dff; font-size: 14px; line-height: 1.6; color: #bbb; }
        .section-header { display: flex; align-items: center; gap: 10px; margin-top: 30px; margin-bottom: 15px; }
        .section-bar { width: 4px; height: 20px; background: #7c4dff; border-radius: 2px; }
        .section-header h3 { font-size: 18px; font-weight: 700; }
        .profile-section { margin-top: 30px; text-align: left; padding: 0 20px; }
        .section-label { font-size: 16px; font-weight: bold; margin-bottom: 10px; display: block; color: var(--primary); }
    </style>
</head>
<body>

<div id="page-container">
    <div class="logo-section"><img src="https://i.postimg.cc/LXRFptGp/20251028-172955.png" alt="Anime07x Logo"></div>
    <div class="search-section"><div class="search-box"><input type="text" id="search-input" placeholder="Search Anime..." oninput="handleSearch(this.value)"></div></div>

    <div id="home-page" class="page active">
        <div class="slider-container"><div class="slider" id="main-slider"></div></div>
        <div class="category-section"><div class="category-header"><h2 class="category-title">Hollywood</h2><span class="view-all" onclick="tab('movies-page')">VIEW ALL</span></div><div class="content-slider" id="hollywood-home"></div></div>
        <div class="category-section"><div class="category-header"><h2 class="category-title">Bollywood</h2><span class="view-all" onclick="tab('movies-page')">VIEW ALL</span></div><div class="content-slider" id="bollywood-home"></div></div>
        <div class="category-section"><div class="category-header"><h2 class="category-title">Web Series</h2><span class="view-all" onclick="tab('series-page')">VIEW ALL</span></div><div class="content-slider" id="web-series-home"></div></div>
        <div class="category-section"><div class="category-header"><h2 class="category-title">South Indian</h2><span class="view-all" onclick="tab('movies-page')">VIEW ALL</span></div><div class="content-slider" id="south-indian-home"></div></div>
        <div class="category-section"><div class="category-header"><h2 class="category-title">Korean</h2><span class="view-all" onclick="tab('series-page')">VIEW ALL</span></div><div class="content-slider" id="korean-home"></div></div>
        <div class="category-section"><div class="category-header"><h2 class="category-title">18+ Content</h2><span class="view-all" onclick="tab('movies-page')">VIEW ALL</span></div><div class="content-slider" id="18-plus-home"></div></div>
    </div>

    <div id="movies-page" class="page"><div class="category-title" style="padding:15px">All Movies</div><div class="grid-view" id="grid-movies"></div></div>
    <div id="series-page" class="page">
        <div class="category-section"><h2 class="category-title">Anime</h2><div class="content-slider" id="series-anime"></div></div>
        <div class="category-section"><h2 class="category-title">KDrama</h2><div class="content-slider" id="series-kdrama"></div></div>
    </div>
    <div id="live-page" class="page"><div class="category-title" style="padding:15px">Live TV</div><div class="grid-view" id="grid-live"></div></div>
    <div id="account-page" class="page">
        <div style="padding: 30px 0; text-align: center;">
            <i class="fas fa-user-circle" style="font-size:80px; color:var(--primary)"></i>
            <h2>Guest User</h2>
            <div style="padding: 0 20px;">
                <button id="appearance-btn" style="margin-top:20px; background:var(--card); color:#fff; border:1px solid var(--border); padding:15px; width:100%; border-radius:12px;" onclick="openThemeModal()">Appearance</button>
                <button id="anim-mode-btn" style="margin-top:12px; background:var(--card); color:#fff; border:1px solid var(--border); padding:15px; width:100%; border-radius:12px; display:flex; justify-content:space-between; align-items:center;" onclick="cycleAnimBorder()">
                    <span>Animation Border</span>
                    <span id="anim-status" style="color:var(--primary); font-weight:bold;">OFF</span>
                </button>
            </div>
            <div class="profile-section"><span class="section-label">My Watchlist</span><div class="content-slider" id="saved-list"></div></div>
            <div class="profile-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span class="section-label" style="margin-bottom: 0;">Recent History</span>
                    <span onclick="clearHistory()" style="font-size: 11px; color: var(--primary); font-weight: bold; cursor: pointer;">CLEAR ALL</span>
                </div>
                <div class="content-slider" id="history-list"></div>
            </div>
        </div>
    </div>
    <div id="detail-page" class="page"></div>

    <!-- PLAYER OVERLAY -->
    <div id="player-overlay">
        <div class="video-wrapper" id="v-wrapper" onclick="togglePlayerUI()" 
             onmousedown="startHoldSpeed()" onmouseup="stopHoldSpeed()" onmouseleave="stopHoldSpeed()"
             ontouchstart="startHoldSpeed()" ontouchend="stopHoldSpeed()">
            
            <video id="main-video" playsinline></video>
            <div id="speed-overlay">2X Speed >></div>

            <!-- SIDE EPISODE DRAWER -->
            <div id="p-ep-drawer" onclick="event.stopPropagation()">
                <div class="drawer-header">
                    <span>EPISODES</span>
                    <i class="fas fa-times" onclick="toggleEpDrawer()"></i>
                </div>
                <div class="drawer-list" id="drawer-ep-list"></div>
            </div>

            <div id="p-speed-menu" onclick="event.stopPropagation()">
                <div class="speed-item" onclick="changeSpeed(0.5)">0.5x</div>
                <div class="speed-item" onclick="changeSpeed(0.75)">0.75x</div>
                <div class="speed-item active" onclick="changeSpeed(1)">1x</div>
                <div class="speed-item" onclick="changeSpeed(1.25)">1.25x</div>
                <div class="speed-item" onclick="changeSpeed(1.5)">1.5x</div>
                <div class="speed-item" onclick="changeSpeed(2)">2x</div>
            </div>
            
            <div class="player-ui" id="player-ui">
                <div class="p-top" onclick="event.stopPropagation()">
                    <button class="p-btn" onclick="closePlayer()"><i class="fas fa-chevron-left"></i></button>
                    <span id="video-title">Loading...</span>
                </div>
                <div class="p-mid"></div>
                <div class="p-bottom-area" onclick="event.stopPropagation()">
                    
                    <!-- UPDATED SEEKBAR WITH TIME INSIDE -->
                    <div class="p-progress-box" onmousedown="startDrag(event)" ontouchstart="startDrag(event)">
                        <span class="seekbar-time" id="p-current">00:00</span>
                        <div class="p-bar-bg"><div id="p-fill"></div></div>
                        <span class="seekbar-time" id="p-duration">00:00</span>
                    </div>

                    <div class="p-controls-bar">
                        <div class="p-left">
                            <button class="p-btn" onclick="togglePlay()"><i class="fas fa-play" id="small-play-btn"></i></button>
                            <div class="p-vol-box">
                                <button class="p-btn" onclick="muteToggle()"><i class="fas fa-volume-high" id="vol-icon"></i></button>
                                <input type="range" id="vol-slider" min="0" max="1" step="0.1" value="1" oninput="setVolume(this.value)">
                            </div>
                        </div>
                        <div class="p-right">
                            <button class="p-btn" id="drawer-arrow-btn" style="display:none;" onclick="toggleEpDrawer(event)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="p-btn hide-in-portrait" onclick="toggleSpeedMenu(event)">
                                <i class="fas fa-gauge-high" style="font-size: 18px; margin-right: 5px;"></i>
                                <span id="speed-label" style="font-size: 11px; font-weight: bold;">1x</span>
                            </button>
                            <button class="p-btn hide-in-portrait" onclick="toggleMenu(event, 'p-quality-menu')">
                                <i class="fas fa-sliders-h" style="font-size: 18px; margin-right: 5px;"></i>
                                <span id="quality-label" style="font-size: 11px; font-weight: bold;">Auto</span>
                            </button>
                            <button class="p-btn hide-in-portrait" onclick="toggleMenu(event, 'p-audio-menu')"><i class="fas fa-language"></i></button>
                            <button class="p-btn hide-in-portrait" onclick="toggleMenu(event, 'p-subtitle-menu')"><i class="fas fa-closed-captioning"></i></button>
                            <button class="p-btn hide-in-portrait" onclick="cycleFit()"><i class="fas fa-expand-alt"></i></button>
                            <button class="p-btn" onclick="handleFullscreen()"><i class="fas fa-expand"></i></button>
                        </div>
                    </div>
                </div>
                <div class="p-menu" id="p-quality-menu"></div>
                <div class="p-menu" id="p-audio-menu"></div>
                <div class="p-menu" id="p-subtitle-menu"></div>
            </div>
        </div>
    </div>

    <div id="confirm-modal">
        <div class="confirm-box">
            <div class="confirm-title">Clear History?</div>
            <div class="confirm-msg">This will remove all your recently watched items.</div>
            <div class="confirm-btns">
                <button class="btn-cancel" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn-confirm" onclick="executeClearHistory()">Clear All</button>
            </div>
        </div>
    </div>

    <div id="appearance-modal">
        <div class="theme-container">
            <div class="theme-grid">
                <div class="theme-card active" onclick="setTheme('#d6006e', 't-pink')">Anime Pink</div>
                <div class="theme-card" onclick="setTheme('#7c4dff', 't-violet')">Classic Violet</div>
            </div>
            <button style="width:100%; padding:10px; margin-top:15px; background:var(--primary); border:none; color:#fff; border-radius:8px;" onclick="closeThemeModal()">Apply</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="tab('home-page')"><i class="fas fa-bolt"></i>Home</div>
        <div class="nav-item" onclick="tab('movies-page')"><i class="fas fa-film"></i>Movies</div>
        <div class="nav-item" onclick="tab('series-page')"><i class="fas fa-layer-group"></i>Series</div>
        <div class="nav-item" onclick="tab('live-page')"><i class="fas fa-desktop"></i>Live</div>
        <div class="nav-item" onclick="tab('account-page')"><i class="fas fa-user-circle"></i>Profile</div>
    </nav>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyAwc9eWzT9OYOCe8hab2ouivQsyEgu2doE", authDomain: "anime07x-c77ba.firebaseapp.com", databaseURL: "https://anime07x-c77ba-default-rtdb.firebaseio.com", projectId: "anime07x-c77ba", storageBucket: "anime07x-c77ba.firebasestorage.app", messagingSenderId: "869262301806", appId: "1:869262301806:web:887cfd924ac0b8b451e47f" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let allData = [], hls = null, uiTimer, dragging = false, speedTimer, currentManualSpeed = 1;
    let currentItem = null; 
    const video = document.getElementById('main-video');
    const playerUI = document.getElementById('player-ui');
    const bottomNav = document.querySelector('.bottom-nav');

    let currentAnimMode = parseInt(localStorage.getItem('animMode')) || 0;
    const animNames = ["OFF", "Style 1", "Style 2", "Style 3"];

    function init() {
        applyAnimMode(currentAnimMode);
        db.ref('/').on('value', snap => {
            const val = snap.val();
            const m = Object.keys(val.movies || {}).map(k => ({id:k, ...val.movies[k], type:'movie'}));
            const s = Object.keys(val.webseries || {}).map(k => ({id:k, ...val.webseries[k], type:'series'}));
            allData = [...m, ...s].sort((a,b) => b.timestamp - a.timestamp);
            renderHome(); renderMovies(); renderSeries(); renderProfileLists();
            renderLive(Object.keys(val.live_tv || {}).map(k => ({id:k, ...val.live_tv[k]})));
        });
    }

    function cycleAnimBorder() {
        currentAnimMode = (currentAnimMode + 1) % animNames.length;
        localStorage.setItem('animMode', currentAnimMode);
        applyAnimMode(currentAnimMode);
    }

    function applyAnimMode(mode) {
        document.body.classList.remove('anim-1', 'anim-2', 'anim-3', 'anim-active');
        if (mode > 0) document.body.classList.add(`anim-${mode}`, 'anim-active');
        document.getElementById('anim-status').innerText = animNames[mode];
    }

    function clearHistory() { document.getElementById('confirm-modal').style.display = 'flex'; }
    function closeConfirmModal() { document.getElementById('confirm-modal').style.display = 'none'; }
    function executeClearHistory() { localStorage.removeItem('history'); renderProfileLists(); closeConfirmModal(); }
    function toggleSpeedMenu(e) { if (e) e.stopPropagation(); const menu = document.getElementById('p-speed-menu'); menu.style.display = (menu.style.display === 'flex' ? 'none' : 'flex'); if(menu.style.display === 'flex') clearTimeout(uiTimer); }
    function changeSpeed(rate) { currentManualSpeed = rate; video.playbackRate = rate; document.getElementById('speed-label').innerText = rate + 'x'; document.getElementById('p-speed-menu').style.display = 'none'; document.querySelectorAll('.speed-item').forEach(item => { item.classList.toggle('active', item.innerText === rate + 'x'); }); }
    function startHoldSpeed() { speedTimer = setTimeout(() => { video.playbackRate = 2.0; document.getElementById('speed-overlay').style.display = 'block'; playerUI.classList.add('hidden'); }, 500); }
    function stopHoldSpeed() { clearTimeout(speedTimer); video.playbackRate = currentManualSpeed; document.getElementById('speed-overlay').style.display = 'none'; }
    
    function playVideo(url, title, contentId) { 
        if(contentId) addToHistory(contentId); 
        document.getElementById('player-overlay').style.display = 'block'; 
        bottomNav.style.display = 'none'; 
        currentItem = allData.find(x => x.id === contentId);
        let category = currentItem ? (currentItem.category || "Series") : "Video";
        document.getElementById('video-title').innerText = category + " | " + title; 
        
        if(currentItem && currentItem.type === 'series' && currentItem.episodes) {
            document.getElementById('drawer-arrow-btn').style.display = 'flex';
            renderEpisodeDrawer();
        } else {
            document.getElementById('drawer-arrow-btn').style.display = 'none';
        }

        document.getElementById('p-ep-drawer').classList.remove('open');
        document.getElementById('quality-label').innerText = 'Auto'; 
        
        if(hls) hls.destroy(); 

        if(url.includes('.m3u8')) { 
            if(Hls.isSupported()) { 
                hls = new Hls({
                    capLevelToPlayerSize: true,
                    autoStartLoad: true
                }); 
                hls.loadSource(url); 
                hls.attachMedia(video); 
                hls.on(Hls.Events.MANIFEST_PARSED, () => { 
                    setupQuality(); 
                    setupAudio(); 
                    setupSubtitles(); 
                    video.play(); 
                }); 
                // Important: Tracks often load after manifest
                hls.on(Hls.Events.LEVEL_SWITCHED, (e, data) => {
                    if(hls.loadLevel === -1) document.getElementById('quality-label').innerText = 'Auto';
                });
                hls.on(Hls.Events.AUDIO_TRACKS_UPDATED, setupAudio); 
                hls.on(Hls.Events.SUBTITLE_TRACKS_UPDATED, setupSubtitles); 
            } 
        } else { 
            video.src = url; 
            video.play(); 
            // Reset menus for MP4
            document.getElementById('p-quality-menu').innerHTML = '<div class="p-menu-header">Not Available</div>';
            document.getElementById('p-audio-menu').innerHTML = '<div class="p-menu-header">Not Available</div>';
            document.getElementById('p-subtitle-menu').innerHTML = '<div class="p-menu-header">Not Available</div>';
        } 
        showUI(); 
    }

    function toggleEpDrawer(e) { if(e) e.stopPropagation(); document.getElementById('p-ep-drawer').classList.toggle('open'); if(document.getElementById('p-ep-drawer').classList.contains('open')) clearTimeout(uiTimer); }

    function renderEpisodeDrawer() {
        if(!currentItem || !currentItem.episodes) return;
        document.getElementById('drawer-ep-list').innerHTML = currentItem.episodes.map((ep, i) => `
            <div class="drawer-item" onclick="playVideo('${ep.link}', '${currentItem.title} - E${i+1}', '${currentItem.id}')">
                <i class="fas fa-play-circle"></i>
                <span>Episode ${i+1}</span>
            </div>
        `).join('');
    }

    // --- TRACK MANAGEMENT FIXED ---
    function setupQuality() { 
        if(!hls || hls.levels.length === 0) return; 
        let html = '<div class="p-menu-header">Quality</div>'; 
        html += `<div class="p-menu-item ${hls.loadLevel === -1 ? 'active' : ''}" onclick="changeQ(-1, 'Auto')">Auto</div>`; 
        hls.levels.forEach((lvl, i) => { 
            let label = lvl.height + "p";
            html += `<div class="p-menu-item ${hls.loadLevel === i ? 'active' : ''}" onclick="changeQ(${i}, '${label}')">${label}</div>`; 
        }); 
        document.getElementById('p-quality-menu').innerHTML = html; 
    }
    
    window.changeQ = (i, label) => { 
        if(hls) {
            hls.currentLevel = i; 
            hls.loadLevel = i; 
            document.getElementById('quality-label').innerText = label; 
            document.getElementById('p-quality-menu').style.display = 'none'; 
            setupQuality(); 
        }
    };

    function setupAudio() { 
        if(!hls) return;
        let html = '<div class="p-menu-header">Audio Track</div>'; 
        if(hls.audioTracks.length <= 1) { 
            html += '<div class="p-menu-item active">Default</div>'; 
        } else { 
            hls.audioTracks.forEach((track, i) => { 
                let name = track.name || track.lang || `Track ${i+1}`;
                html += `<div class="p-menu-item ${hls.audioTrack === i ? 'active' : ''}" onclick="changeAudio(${i})">${name}</div>`; 
            }); 
        } 
        document.getElementById('p-audio-menu').innerHTML = html; 
    }
    
    window.changeAudio = (i) => { 
        if(hls) {
            hls.audioTrack = i; 
            setupAudio(); 
            document.getElementById('p-audio-menu').style.display = 'none'; 
        }
    };

    function setupSubtitles() { 
        if(!hls) return;
        let html = '<div class="p-menu-header">Subtitles</div>'; 
        html += `<div class="p-menu-item ${hls.subtitleTrack === -1 ? 'active' : ''}" onclick="changeSub(-1)">Off</div>`; 
        if(hls.subtitleTracks.length > 0) { 
            hls.subtitleTracks.forEach((track, i) => { 
                let name = track.name || track.lang || `Subtitle ${i+1}`;
                html += `<div class="p-menu-item ${hls.subtitleTrack === i ? 'active' : ''}" onclick="changeSub(${i})">${name}</div>`; 
            }); 
        } 
        document.getElementById('p-subtitle-menu').innerHTML = html; 
    }
    
    window.changeSub = (i) => { 
        if(hls) {
            hls.subtitleTrack = i; 
            hls.subtitleDisplay = (i !== -1);
            setupSubtitles(); 
            document.getElementById('p-subtitle-menu').style.display = 'none'; 
        }
    };

    function setVolume(v) { video.volume = v; video.muted = (v == 0); updateVolIcon(); }
    function muteToggle() { video.muted = !video.muted; document.getElementById('vol-slider').value = video.muted ? 0 : video.volume; updateVolIcon(); }
    function updateVolIcon() { let icon = video.muted || video.volume == 0 ? 'fas fa-volume-xmark' : (video.volume < 0.5 ? 'fas fa-volume-low' : 'fas fa-volume-high'); document.getElementById('vol-icon').className = icon; }
    function toggleMenu(e, id) { if (e) e.stopPropagation(); const menu = document.getElementById(id); const isOpen = menu.style.display === 'flex'; document.querySelectorAll('.p-menu').forEach(m => m.style.display = 'none'); if(!isOpen) { menu.style.display = 'flex'; clearTimeout(uiTimer); } }
    function togglePlay() { video.paused ? (video.play(), updateIcons('fas fa-pause')) : (video.pause(), updateIcons('fas fa-play')); }
    function updateIcons(cls) { document.getElementById('small-play-btn').className = cls; }
    
    video.ontimeupdate = () => { 
        if(!dragging && video.duration) { 
            const p = (video.currentTime / video.duration) * 100; 
            document.getElementById('p-fill').style.width = p + '%'; 
            document.getElementById('p-current').innerText = fmt(video.currentTime); 
            document.getElementById('p-duration').innerText = fmt(video.duration); 
        } 
    };

    function fmt(s) { let m = Math.floor(s/60); s = Math.floor(s%60); return (m<10?'0'+m:m)+":"+(s<10?'0'+s:s); }
    function startDrag(e) { dragging = true; doDrag(e); window.addEventListener('mousemove', doDrag); window.addEventListener('mouseup', stopDrag); window.addEventListener('touchmove', doDrag); window.addEventListener('touchend', stopDrag); }
    function doDrag(e) { const rect = document.querySelector('.p-bar-bg').getBoundingClientRect(); const x = (e.clientX || (e.touches && e.touches[0].clientX)); let pos = (x - rect.left) / rect.width; pos = Math.max(0, Math.min(1, pos)); document.getElementById('p-fill').style.width = (pos*100)+'%'; if(video.duration) video.currentTime = pos * video.duration; }
    function stopDrag() { dragging = false; window.removeEventListener('mousemove', doDrag); window.removeEventListener('mouseup', stopDrag); window.removeEventListener('touchmove', doDrag); window.removeEventListener('touchend', stopDrag); }
    async function handleFullscreen() { const wrap = document.getElementById('v-wrapper'); if(!document.fullscreenElement) { if(wrap.requestFullscreen) await wrap.requestFullscreen(); else if(wrap.webkitRequestFullscreen) await wrap.webkitRequestFullscreen(); if(screen.orientation && screen.orientation.lock) screen.orientation.lock('landscape').catch(()=>{}); showUI(); } else { if(document.exitFullscreen) document.exitFullscreen(); else if(document.webkitExitFullscreen) document.webkitExitFullscreen(); } }
    let fit = 0; function cycleFit() { const ms = ['contain','cover','fill']; fit = (fit+1)%3; video.style.objectFit = ms[fit]; }
    function showUI() { playerUI.classList.remove('hidden'); clearTimeout(uiTimer); uiTimer = setTimeout(()=> { if(Array.from(document.querySelectorAll('.p-menu')).some(m => m.style.display === 'flex')) return; if(document.getElementById('p-speed-menu').style.display === 'flex') return; if(document.getElementById('p-ep-drawer').classList.contains('open')) return; playerUI.classList.add('hidden'); }, 3500); }
    function togglePlayerUI() { if(document.getElementById('p-ep-drawer').classList.contains('open')) { document.getElementById('p-ep-drawer').classList.remove('open'); return; } if(playerUI.classList.contains('hidden')) showUI(); else playerUI.classList.add('hidden'); }
    function closePlayer() { video.pause(); document.getElementById('player-overlay').style.display='none'; bottomNav.style.display = 'flex'; if(document.fullscreenElement) document.exitFullscreen(); }
    function addToHistory(id) { let history = JSON.parse(localStorage.getItem('history') || '[]'); history = history.filter(x => x !== id); history.unshift(id); if(history.length > 20) history.pop(); localStorage.setItem('history', JSON.stringify(history)); }
    function toggleSaveEpisode(seriesId, epIdx) { let epId = seriesId + "_ep_" + epIdx; let saved = JSON.parse(localStorage.getItem('saved') || '[]'); if(saved.includes(epId)) saved = saved.filter(x => x !== epId); else saved.push(epId); localStorage.setItem('saved', JSON.stringify(saved)); showDetail(seriesId); renderProfileLists(); }
    function toggleSave(id) { let saved = JSON.parse(localStorage.getItem('saved') || '[]'); saved.includes(id) ? (saved = saved.filter(x => x !== id)) : saved.push(id); localStorage.setItem('saved', JSON.stringify(saved)); showDetail(id); renderProfileLists(); }
    function renderProfileLists() { let hIds = JSON.parse(localStorage.getItem('history') || '[]'); let sIds = JSON.parse(localStorage.getItem('saved') || '[]'); fill('history-list', hIds.map(id => allData.find(x => x.id === id)).filter(x => x)); let savedItems = []; sIds.forEach(id => { if(id.includes('_ep_')) { let [seriesId, , epIdx] = id.split('_'); let parent = allData.find(x => x.id === seriesId); if(parent) savedItems.push({ ...parent, id: seriesId, title: parent.title + " - E" + (parseInt(epIdx)+1) }); } else { let item = allData.find(x => x.id === id); if(item) savedItems.push(item); } }); fill('saved-list', savedItems); }
    function renderHome() { document.getElementById('main-slider').innerHTML = allData.slice(0,5).map(i => `<div class="slide" onclick="showDetail('${i.id}')"><img src="${i.backdrop}"></div>`).join(''); fill('hollywood-home', allData.filter(i => i.category === 'Hollywood')); fill('bollywood-home', allData.filter(i => i.category === 'Bollywood')); fill('web-series-home', allData.filter(i => i.type === 'series').slice(0,10)); fill('south-indian-home', allData.filter(i => i.category === 'South Indian')); fill('korean-home', allData.filter(i => i.category === 'Korean' || i.category === 'KDrama')); fill('18-plus-home', allData.filter(i => i.category === '18+')); }
    function renderMovies() { document.getElementById('grid-movies').innerHTML = allData.filter(i => i.type==='movie').map(i => card(i)).join(''); }
    function renderSeries() { fill('series-anime', allData.filter(i => i.category === 'Anime')); fill('series-kdrama', allData.filter(i => i.category === 'KDrama')); }
    function renderLive(live) { document.getElementById('grid-live').innerHTML = live.map(i => `<div onclick="playVideo('${i.link}', '${i.name}')" style="background:var(--card); padding:10px; border-radius:10px; text-align:center;"><img src="${i.logo}" style="width:100%; height:50px; object-fit:contain;"><p style="font-size:10px;">${i.name}</p></div>`).join(''); }
    function fill(id, list) { document.getElementById(id).innerHTML = list.length > 0 ? list.map(i => card(i)).join('') : '<p style="padding:15px; opacity:0.5; font-size:12px;">Nothing here</p>'; }
    function card(i) { return `<div class="content-card" onclick="showDetail('${i.id}')"><img src="${i.poster}"><div class="card-title">${i.title}</div></div>`; }
    function tab(id) { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n=>n.classList.toggle('active', n.getAttribute('onclick').includes(id))); if(id === 'account-page') renderProfileLists(); }
    function showDetail(id) { const item = allData.find(i => i.id === id); if(!item) return; let savedIds = JSON.parse(localStorage.getItem('saved') || '[]'); let isSaved = savedIds.includes(id); let eps = (item.episodes || []).map((e, idx) => { let epId = item.id + "_ep_" + idx; let isEpSaved = savedIds.includes(epId); return ` <div class="ep-list-item"> <span onclick="playVideo('${e.link}', '${item.title} - E${idx+1}', '${item.id}')" style="flex:1;">Episode ${idx+1}</span> <div style="display:flex; gap:20px; align-items:center;"> <i class="fas ${isEpSaved ? 'fa-check' : 'fa-plus'}" onclick="toggleSaveEpisode('${item.id}', ${idx})" style="color:${isEpSaved ? 'var(--primary)' : '#fff'}; cursor:pointer;"></i> <i class="fas fa-play-circle" onclick="playVideo('${e.link}', '${item.title} - E${idx+1}', '${item.id}')" style="color:var(--primary); font-size:20px;"></i> </div> </div>`; }).join(''); document.getElementById('detail-page').innerHTML = ` <div class="detail-backdrop"> <button onclick="tab('home-page')" style="position:absolute; top:20px; left:20px; z-index:10; background:rgba(0,0,0,0.5); width:45px; height:45px; border-radius:50%; border:none; color:#fff;"><i class="fas fa-arrow-left"></i></button> <img src="${item.backdrop}"> <div class="backdrop-overlay"></div> </div> <div class="detail-content"> <div class="detail-main"> <img class="detail-poster-img" src="${item.poster}"> <div class="detail-info"><h2>${item.title}</h2><div class="meta-badges"><span class="badge">2025</span><span class="badge"><i class="fas fa-star"></i> 8.5</span><span class="badge">${item.category || 'undefined'}</span></div></div> </div> <div class="detail-actions"> <button class="btn-episodes" onclick="document.getElementById('ep-section').scrollIntoView({behavior:'smooth'})"><i class="fas fa-list-ul"></i> EPISODES</button> <button class="btn-plus" onclick="toggleSave('${item.id}')"><i class="fas ${isSaved ? 'fa-check' : 'fa-plus'}"></i></button> </div> <div class="desc-box">Anime07x<br>OWNER BY RIDHAM BOHARA</div> <div class="section-header"><div class="section-bar"></div><h3>Play List</h3></div> <div id="ep-section" style="padding-bottom:50px;"> ${item.type === 'movie' ? `<div class="ep-list-item" onclick="playVideo('${item.link}', '${item.title}', '${item.id}')"><span>Watch Movie</span><i class="fas fa-play-circle" style="color:#7c4dff"></i></div>` : eps} </div> </div>`; tab('detail-page'); }
    function handleSearch(q) { if(!q) { renderMovies(); return; } const f = allData.filter(i => i.title.toLowerCase().includes(q.toLowerCase())); document.getElementById('grid-movies').innerHTML = f.map(i => card(i)).join(''); tab('movies-page'); }
    function setTheme(c, id) { document.documentElement.style.setProperty('--primary', c); closeThemeModal(); }
    function openThemeModal() { document.getElementById('appearance-modal').style.display='flex'; }
    function closeThemeModal() { document.getElementById('appearance-modal').style.display='none'; }

    init();
</script>
</body>
</html>